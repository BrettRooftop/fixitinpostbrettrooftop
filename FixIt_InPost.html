<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixIt_InPost | Editor's Utility</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            /* Funky Palette inspired by the references */
            --color-bg-main: #FFF0F5; /* Lavender Blush */
            --color-card-bg: #ffffff;
            --color-text-main: #111827;
            
            /* Pop Accents */
            --pop-purple: #a855f7;
            --pop-pink: #ff69b4;
            --pop-lime: #bef264;
            --pop-yellow: #fde047;
            --pop-blue: #60a5fa;
            --pop-orange: #fb923c;
            --pop-dark: #1f2937;

            --shadow-hard: 4px 4px 0px 0px rgba(0,0,0,1);
            --shadow-hard-hover: 6px 6px 0px 0px rgba(0,0,0,1);
            --border-thick: 3px solid #000;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--color-bg-main);
            color: var(--color-text-main);
            overflow: hidden;
            background-image: radial-gradient(#dbdbdb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Funky Background SVG Container */
        .funky-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
            pointer-events: none; 
            overflow: hidden;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar - Bold & Chunky */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; border-left: 2px solid black; }
        ::-webkit-scrollbar-thumb { background: var(--pop-purple); border: 2px solid black; }
        ::-webkit-scrollbar-thumb:hover { background: var(--pop-pink); }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-15px) rotate(2deg); } }
        @keyframes float-reverse { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-10px) rotate(-2deg); } }
        @keyframes pulse-scale { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); } }

        .spinner { animation: spin 1s linear infinite; }
        .animate-float { animation: float 6s ease-in-out infinite; }
        .animate-float-rev { animation: float-reverse 7s ease-in-out infinite; }
        .animate-pulse-slow { animation: pulse-scale 3s ease-in-out infinite; }
        .animate-pulse-green { animation: pulse-green 2s infinite; }

        /* Color Input Styling */
        input[type="color"] { -webkit-appearance: none; border: none; width: 100%; height: 100%; padding: 0; background: none;}
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 8px; }
        
        /* Checkbox Styling - Retro Style */
        .custom-checkbox {
            appearance: none;
            background-color: white;
            border: 2px solid black;
            width: 1.5rem;
            height: 1.5rem;
            display: inline-grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 2px 2px 0px 0px black;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.85rem;
            height: 0.85rem;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            background-color: black;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked {
            background-color: var(--pop-lime);
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px 0px black;
        }
        .custom-checkbox:checked::before { transform: scale(1); }

        /* Funky UI Elements - Neo-Brutalist Style */
        .funky-card {
            background: var(--color-card-bg);
            border: var(--border-thick);
            box-shadow: var(--shadow-hard);
            transition: all 0.2s ease;
            position: relative;
        }
        /* Decoration for cards to look like stickers */
        .sticker-look {
            border-radius: 0px; /* Sharp edges */
        }
        
        .funky-card:hover {
            transform: translate(-2px, -2px);
            box-shadow: var(--shadow-hard-hover);
        }

        .funky-gradient-text {
            background: linear-gradient(to right, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .funky-button-primary {
            background-color: var(--pop-purple);
            color: white;
            border: 2px solid black;
            font-weight: 700;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0px 0px black;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .funky-button-primary:hover {
            background-color: #9333ea;
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0px 0px black;
        }
        .funky-button-primary:active {
            transform: translate(0px, 0px);
            box-shadow: 0px 0px 0px 0px black;
        }

        .funky-input {
            background: #fff;
            border: 2px solid black;
            border-radius: 0;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
            color: var(--color-text-main);
            box-shadow: 3px 3px 0px 0px #e5e7eb;
        }
        .funky-input:focus {
            border-color: var(--pop-pink);
            box-shadow: 4px 4px 0px 0px var(--pop-pink);
            outline: none;
            background: #fff;
        }
        .funky-textarea {
            @apply funky-input;
            resize: none;
        }
        
        /* Drag and Drop Styles */
        .draggable-note {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .draggable-note:active {
            cursor: grabbing;
        }
        .draggable-note.dragging {
            opacity: 0.5;
            background: #fff;
            border: 2px dashed black;
            box-shadow: none;
            transform: scale(0.95);
        }
        .draggable-note.drag-over {
            border-top: 4px solid var(--pop-purple);
            margin-top: 10px;
        }

        /* Toast Animation */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 300ms ease-out; }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 300ms ease-in; }

        /* Game Canvas Style */
        #game-canvas {
            image-rendering: pixelated;
        }
        
        /* Game Over Overlay */
        #game-over-screen {
            background: rgba(0, 0, 0, 0.85);
        }
        
        /* Utility classes for the quirky look */
        .brutal-shadow { box-shadow: 3px 3px 0px 0px black; }
        .brutal-shadow-sm { box-shadow: 2px 2px 0px 0px black; }

        /* Retro CRT Effect for Share Card */
        .share-card {
            background: #111;
            border: 4px solid #bef264;
            box-shadow: 4px 4px 0px 0px #a855f7;
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Funky Background Elements (Quirky & Playful) -->
    <div class="funky-bg">
        <!-- Floating Shapes -->
        <div class="absolute top-10 left-10 w-32 h-32 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl opacity-50 animate-float"></div>
        <div class="absolute bottom-20 right-20 w-40 h-40 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-50 animate-float-rev"></div>
        
        <svg width="100%" height="100%" viewBox="0 0 1440 900" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
            <!-- Big Quirky Star (Top Right) -->
            <path id="easter-egg-star" onclick="openSpaceInvaders()" class="animate-float hover:rotate-180 transition-transform duration-700 cursor-pointer" style="pointer-events: auto;" d="M1300,50 L1320,120 L1390,120 L1335,165 L1355,235 L1300,190 L1245,235 L1265,165 L1210,120 L1280,120 Z" fill="#bef264" stroke="black" stroke-width="3" />
            
            <!-- ZigZag Line (Left) -->
            <path d="M-20,400 L50,450 L-20,500 L50,550 L-20,600" stroke="#f472b6" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round" />

            <!-- Squiggle (Bottom Center) -->
            <path class="animate-float-rev" d="M600,850 Q650,800 700,850 T800,850" stroke="#a855f7" stroke-width="12" fill="none" stroke-linecap="round" />

            <!-- Geometric Triangles (Background) -->
            <polygon points="200,100 250,200 150,200" fill="none" stroke="#60a5fa" stroke-width="4" opacity="0.6" transform="rotate(15 200 150)" />
            <polygon points="1100,700 1150,800 1050,800" fill="none" stroke="#fde047" stroke-width="4" opacity="0.6" transform="rotate(-25 1100 750)" />

            <!-- Dots/Confetti -->
            <circle cx="400" cy="150" r="8" fill="#111" />
            <circle cx="420" cy="180" r="5" fill="#111" />
            <circle cx="380" cy="170" r="6" fill="#f472b6" />
            
            <rect x="900" y="100" width="20" height="20" fill="#a855f7" stroke="black" stroke-width="2" transform="rotate(45 910 110)" />
        </svg>
    </div>

    <!-- Navbar -->
    <header class="h-20 flex items-center px-8 justify-between shrink-0 z-20 bg-white border-b-4 border-black relative">
        <div class="flex items-center gap-4">
            <div class="bg-yellow-300 p-2 border-2 border-black brutal-shadow-sm transform -rotate-3">
                <i data-lucide="clapperboard" class="w-6 h-6 text-black"></i>
            </div>
            <div>
                <h1 class="font-black text-2xl tracking-tighter uppercase italic transform -skew-x-6">FixIt_<span class="text-purple-600">InPost</span></h1>
                <div class="text-[10px] font-bold bg-black text-white inline-block px-2 py-0.5 transform skew-x-6">EDITOR'S UTILITY</div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <!-- LOCAL SAVE STATUS BUTTON (REPLACED ONEDRIVE) -->
            <button class="w-10 h-10 flex items-center justify-center bg-lime-400 text-black border-2 border-black rounded-full shadow-[2px_2px_0px_0px_black]" title="Data saved locally to your browser (localStorage)">
                <i data-lucide="hard-drive" class="w-5 h-5"></i>
            </button>

             <button onclick="openDataModal()" class="w-10 h-10 flex items-center justify-center bg-blue-400 hover:bg-blue-500 text-black border-2 border-black rounded-full shadow-[2px_2px_0px_0px_black] hover:translate-y-px hover:shadow-none transition-all" title="Data Options (Export/Import)">
                <i data-lucide="hard-drive-download" class="w-5 h-5"></i>
            </button>
            
             <button onclick="openAboutModal()" class="w-10 h-10 flex items-center justify-center bg-pink-400 hover:bg-pink-500 text-black border-2 border-black rounded-full shadow-[2px_2px_0px_0px_black] hover:translate-y-px hover:shadow-none transition-all" title="About">
                <i data-lucide="help-circle" class="w-6 h-6"></i>
            </button>
            <button onclick="openApiKeyModal()" id="api-status-btn" class="text-sm font-bold flex items-center gap-2 bg-white hover:bg-gray-50 text-black px-4 py-2 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-0.5 transition-all">
                <i data-lucide="key" class="w-4 h-4"></i> <span id="api-btn-text">Set API Key</span>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden p-6 gap-6 z-10 pointer-events-none relative">
        
        <!-- LEFT PANEL: Timer & Colors -->
        <aside class="w-72 flex flex-col gap-6 z-30 pointer-events-auto">
            
            <!-- TASK TIME COUNTER -->
            <div class="funky-card sticker-look bg-orange-50 shrink-0 relative overflow-hidden flex flex-col">
                <div class="absolute -top-3 right-8 w-20 h-6 bg-green-200/80 -rotate-3 shadow-sm z-20"></div>
                <div class="p-4 border-b-2 border-black flex justify-between items-center bg-orange-100 shrink-0">
                     <h2 class="text-sm font-black uppercase flex items-center gap-2">
                        <i data-lucide="timer" class="w-4 h-4 text-black"></i> Task Timer
                    </h2>
                     <div class="flex items-center gap-2">
                        <button onclick="openExpandedTimer()" class="w-6 h-6 flex items-center justify-center bg-white border border-black hover:bg-orange-200 transition-colors" title="Expand Timer">
                            <i data-lucide="maximize-2" class="w-3 h-3"></i>
                        </button>
                        <div id="timer-status" class="w-3 h-3 rounded-full bg-red-500 border border-black shadow-[1px_1px_0px_0px_black]"></div>
                     </div>
                </div>
                <div class="p-4 bg-white flex flex-col min-h-0">
                    <div onclick="openManualLogModal()" class="text-4xl font-black font-mono text-center mb-4 tracking-widest bg-gray-50 border-2 border-black p-2 shadow-[2px_2px_0px_0px_rgba(0,0,0,0.1)] cursor-pointer hover:bg-yellow-50 transition-colors" title="Click to manually log time">
                        <span id="timer-display">00:00:00</span>
                    </div>
                    <input type="text" id="task-name" placeholder="Task Name..." class="w-full text-xs font-bold border-2 border-black p-2 mb-4 focus:outline-none focus:bg-yellow-50 focus:shadow-[2px_2px_0px_0px_black] transition-all">
                    <div class="flex gap-2 mb-4 shrink-0">
                        <button onclick="toggleTimer()" id="timer-toggle-btn" class="flex-1 bg-green-400 hover:bg-green-500 text-black font-black border-2 border-black p-2 shadow-[2px_2px_0px_0px_black] active:translate-y-px active:shadow-none transition-all uppercase text-xs flex items-center justify-center gap-1">
                           <i data-lucide="play" class="w-3 h-3"></i> Start
                        </button>
                        <button onclick="stopAndSaveTimer()" class="w-12 bg-red-400 hover:bg-red-500 text-black font-bold border-2 border-black p-2 shadow-[2px_2px_0px_0px_black] active:translate-y-px active:shadow-none transition-all flex items-center justify-center" title="Stop & Save">
                            <i data-lucide="square" class="w-4 h-4 fill-current"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center text-[10px] font-black uppercase text-gray-500 mb-2 px-1">
                        <span>History Log</span>
                        <span>Total: <span id="total-time-display" class="text-black">0h 0m</span></span>
                    </div>
                    <div class="flex-1 overflow-y-auto border-t-2 border-black pt-2 min-h-[80px] max-h-[120px]">
                        <div id="task-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Color Palette -->
            <div class="funky-card sticker-look flex-1 flex flex-col">
                <div class="p-4 border-b-2 border-black bg-pink-100 flex justify-between items-center shrink-0">
                    <div class="flex items-center gap-2">
                        <h2 class="text-sm font-black uppercase tracking-tight flex items-center gap-2 transform rotate-1">
                            <i data-lucide="palette" class="w-4 h-4 text-black"></i> Colours
                        </h2>
                        <!-- Tooltip Container -->
                        <div class="group relative flex items-center ml-2">
                            <i data-lucide="help-circle" class="w-4 h-4 text-gray-500 hover:text-pink-600 transition-colors cursor-help"></i>
                            <div class="absolute left-full top-1/2 -translate-y-1/2 ml-3 w-48 bg-black text-white text-xs font-medium p-2 rounded-lg border-2 border-white shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
                                <div class="absolute left-[-6px] top-1/2 -translate-y-1/2 w-3 h-3 bg-black border-l-2 border-b-2 border-white transform rotate-45"></div>
                                Stop guessing hex codes! Paste a #hex to save it, or use this palette to keep your brand colours from getting lost in the timeline chaos. <i data-lucide="palette" class="inline w-3 h-3 text-pink-400 align-text-bottom"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-3 border-b-2 border-black bg-white flex flex-col gap-2">
                    <div class="relative w-full">
                        <input type="color" id="native-color-picker" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10" onchange="handleAddColor(this.value)">
                        <button class="w-full bg-white hover:bg-gray-50 text-black text-xs font-bold py-2 border-2 border-black flex items-center justify-center gap-2 transition-all brutal-shadow-sm">
                            <i data-lucide="pipette" class="w-4 h-4"></i> PICK NEW
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <input type="text" id="manual-color-input" placeholder="#Hex, RGB" class="flex-1 text-[10px] font-bold border-2 border-black p-2 focus:bg-pink-50 focus:outline-none uppercase font-mono" onkeydown="if(event.key === 'Enter') handleManualColorSubmit()">
                         <button onclick="handleManualColorSubmit()" class="w-8 bg-black text-white flex items-center justify-center border-2 border-black hover:bg-gray-800 transition-colors" title="Add">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div id="swatch-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-5 gap-3 content-start bg-white"></div>
            </div>
        </aside>

        <!-- CENTER PANEL: Smart Paste Area -->
        <main class="flex-1 flex flex-col relative gap-6 z-20 pointer-events-auto">
            
            <!-- Toast Container -->
            <div id="toast-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 pointer-events-none flex flex-col gap-2 w-full max-w-sm items-center"></div>

            <!-- Input/Output Wrapper -->
            <div class="funky-card sticker-look flex-1 flex flex-col p-6 gap-4 bg-white">
                 <div class="absolute -top-3 right-12 w-32 h-8 bg-blue-200/80 -rotate-2 shadow-sm z-20"></div>

                 <!-- Magic Box Header -->
                 <div class="flex items-center gap-2 mb-2 border-b-2 border-black pb-2">
                     <div class="flex items-center gap-2 flex-1">
                        <i data-lucide="wand-2" class="w-5 h-5 text-purple-600"></i>
                        <h2 class="text-xl font-black italic uppercase tracking-tight">Magic AI Box</h2>
                        <!-- Tooltip Container -->
                        <div class="group relative flex items-center">
                            <i data-lucide="help-circle" class="w-5 h-5 text-gray-400 hover:text-purple-600 transition-colors cursor-help"></i>
                            <div class="absolute left-full top-1/2 -translate-y-1/2 ml-3 w-64 bg-black text-white text-xs font-medium p-3 rounded-lg border-2 border-white shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50">
                                <div class="absolute left-[-6px] top-1/2 -translate-y-1/2 w-3 h-3 bg-black border-l-2 border-b-2 border-white transform rotate-45"></div>
                                Paste your chaos here! I automatically fix broken timecodes, swap file paths between mac and windows, translate foreign text, and summarize angry client feedback into checklists. <i data-lucide="sparkles" class="inline w-3 h-3 text-purple-400 align-text-bottom"></i>
                            </div>
                        </div>
                     </div>
                 </div>

                <!-- Input Area -->
                <div class="flex-1 flex flex-col min-h-0">
                    <label class="text-xs font-black text-black mb-2 uppercase flex justify-between items-end">
                        <span class="bg-yellow-300 px-2 border-2 border-black">RAW INPUT</span>
                        <div class="flex gap-2">
                            <button onclick="openCustomAiModal()" class="text-xs font-bold text-purple-600 hover:text-white hover:bg-purple-600 px-2 py-0.5 border border-purple-200 hover:border-black transition-all flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> CUSTOM TASK
                            </button>
                            <button onclick="clearInput()" class="text-xs font-bold text-red-500 hover:text-white hover:bg-red-500 px-2 py-0.5 border border-transparent hover:border-black transition-all flex items-center gap-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> CLEAR
                            </button>
                        </div>
                    </label>
                    <div class="relative flex-1 flex flex-col">
                         <textarea 
                            id="main-input" 
                            class="funky-textarea flex-1 mono text-sm placeholder-gray-300 border-2 border-black focus:ring-0 focus:border-black focus:shadow-[4px_4px_0px_0px_#a855f7]"
                            placeholder="// Paste win / mac paths, broken timecodes and SRTs, summarize client notes, or paste text for translation..."
                        ></textarea>
                    </div>
                </div>

                <!-- Action Arrow -->
                <div class="flex justify-center items-center shrink-0 h-10">
                    <div id="process-indicator" class="bg-black text-white rounded-full p-2 border-2 border-white outline outline-2 outline-black transition-all duration-500 z-10">
                        <i data-lucide="arrow-down" class="w-6 h-6"></i>
                    </div>
                </div>

                <!-- Output Area -->
                <div class="flex-1 flex flex-col min-h-0">
                    <label class="text-xs font-black text-black mb-2 uppercase flex justify-between items-center">
                        <span id="output-label" class="bg-green-300 px-2 border-2 border-black">SMART OUTPUT</span>
                        <div class="flex gap-2">
                            <button id="checklist-btn" onclick="toggleChecklistMode()" class="hidden bg-white hover:bg-gray-50 text-black px-3 py-1 text-xs font-bold flex items-center gap-1 transition-all border-2 border-black shadow-[2px_2px_0px_0px_black]">
                                <i data-lucide="check-square" class="w-3 h-3"></i> INTERACTIVE
                            </button>
                            <button id="save-checklist-btn" onclick="saveChecklistToNotes()" class="hidden bg-blue-400 hover:bg-blue-500 text-black px-3 py-1 text-xs font-bold flex items-center gap-1 transition-all border-2 border-black shadow-[2px_2px_0px_0px_black]">
                                <i data-lucide="save" class="w-3 h-3"></i> SAVE NOTE
                            </button>
                            <button id="save-color-btn" onclick="saveCurrentOutputColor()" class="hidden bg-pink-400 hover:bg-pink-500 text-black px-3 py-1 text-xs font-bold flex items-center gap-1 transition-all border-2 border-black shadow-[2px_2px_0px_0px_black]">
                                <i data-lucide="plus" class="w-3 h-3"></i> ADD COLOR
                            </button>
                            <a id="external-link-btn" href="#" target="_blank" class="hidden bg-white hover:bg-gray-50 text-blue-600 px-3 py-1 text-xs font-bold flex items-center gap-1 transition-all border-2 border-blue-600 no-underline">
                                <i data-lucide="external-link" class="w-3 h-3"></i> Translate
                            </a>
                            <button onclick="copyOutput()" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 flex items-center gap-1 text-xs font-bold transition-all border-2 border-black shadow-[2px_2px_0px_0px_black] active:shadow-none active:translate-y-0.5">
                                <i data-lucide="copy" class="w-3 h-3"></i> COPY
                            </button>
                        </div>
                    </label>
                    <div class="relative flex-1 group min-h-0 flex flex-col">
                        <div id="color-preview-overlay" class="absolute top-4 right-4 w-12 h-12 rounded-full border-4 border-black brutal-shadow hidden pointer-events-none z-10"></div>
                        <div id="checklist-overlay" class="absolute inset-0 bg-white/95 backdrop-blur-sm border-2 border-black p-4 overflow-y-auto hidden z-20"></div>
                        
                        <textarea 
                            id="main-output" 
                            readonly
                            class="funky-textarea w-full h-full bg-gray-50 text-gray-800 mono text-sm border-2 border-black focus:border-black"
                            placeholder=""
                        ></textarea>
                        
                        <div id="ai-badge" class="hidden absolute bottom-4 right-4 flex items-center gap-2 text-xs font-black text-white bg-gradient-to-r from-purple-600 to-blue-500 px-4 py-1.5 border-2 border-black brutal-shadow-sm transform -rotate-2 pointer-events-none">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> GEMINI POWER
                        </div>

                        <div id="copy-overlay" class="absolute inset-0 bg-black/80 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200 z-30">
                            <div class="text-white font-black text-2xl flex items-center gap-3 uppercase transform -rotate-3"><i data-lucide="check-circle" class="w-10 h-10 text-green-400"></i> Copied!</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- RIGHT PANEL: Notes Only -->
        <aside class="w-80 flex flex-col gap-6 z-10 pointer-events-auto">
            <div class="funky-card sticker-look flex-1 flex flex-col overflow-hidden bg-white">
                 <div class="absolute -top-3 left-4 w-16 h-6 bg-pink-200/80 rotate-3 shadow-sm z-20"></div>
                <div class="p-4 border-b-2 border-black bg-blue-100 shrink-0">
                    <h2 class="text-sm font-black uppercase tracking-tight mb-4 flex items-center gap-2">
                        <i data-lucide="book-open" class="w-4 h-4 text-black"></i> Quick Notes
                    </h2>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-black"></i>
                        <input type="text" id="note-search" onkeyup="renderNotes()" placeholder="Search..." class="w-full pl-10 py-2 text-sm border-2 border-black focus:bg-yellow-50 focus:outline-none transition-colors placeholder-gray-500 font-bold">
                    </div>
                </div>
                <div id="notes-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px]"></div>
                <div class="p-4 border-t-2 border-black shrink-0 bg-white">
                    <button onclick="openNoteModal()" class="funky-button-primary w-full flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="plus" class="w-5 h-5"></i> Add New Note
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Modals (All included) -->
    
    <!-- EXPANDED TIMER MODAL -->
    <div id="timer-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#fb923c] w-full max-w-lg transform transition-all scale-95 opacity-0 p-0" id="timer-modal-content">
            <div class="bg-orange-400 p-4 border-b-2 border-black flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i data-lucide="timer" class="w-6 h-6 text-black"></i>
                    <h3 class="text-xl font-black text-black uppercase italic">Time Station</h3>
                </div>
                <button onclick="closeExpandedTimer()" class="text-black hover:bg-white/20 p-1 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6">
                <!-- Big Display -->
                <div class="text-center mb-6">
                    <div class="text-xs font-black uppercase text-gray-400 mb-1">Current Session</div>
                    <div class="text-6xl font-black font-mono tracking-widest bg-gray-50 border-4 border-black p-4 shadow-[4px_4px_0px_0px_rgba(0,0,0,0.1)] inline-block">
                        <span id="expanded-timer-display">00:00:00</span>
                    </div>
                    <div class="mt-4 flex justify-center">
                         <div id="expanded-task-name" class="text-lg font-bold bg-yellow-100 px-3 py-1 border-2 border-black rotate-1">No Active Task</div>
                    </div>
                </div>
                
                <!-- Controls -->
                 <div class="flex gap-4 mb-8 justify-center">
                    <button onclick="toggleTimer()" id="expanded-timer-toggle-btn" class="w-32 bg-green-400 hover:bg-green-500 text-black font-black border-2 border-black p-3 shadow-[4px_4px_0px_0px_black] active:translate-y-0.5 active:shadow-none transition-all uppercase text-sm flex items-center justify-center gap-2">
                       <i data-lucide="play" class="w-4 h-4"></i> Start
                    </button>
                    <button onclick="stopAndSaveTimer()" class="w-32 bg-red-400 hover:bg-red-500 text-black font-bold border-2 border-black p-3 shadow-[4px_4px_0px_0px_black] active:translate-y-0.5 active:shadow-none transition-all flex items-center justify-center gap-2 uppercase text-sm">
                        <i data-lucide="square" class="w-4 h-4 fill-current"></i> Stop
                    </button>
                </div>
                
                <!-- Stats -->
                 <div class="grid grid-cols-2 gap-4 border-t-2 border-black pt-6">
                     <div class="bg-blue-50 p-3 border-2 border-black">
                         <div class="text-[10px] font-black uppercase text-gray-500">Total Logged</div>
                         <div id="expanded-total-time" class="text-2xl font-black text-blue-600">0h 0m</div>
                     </div>
                     <div class="bg-pink-50 p-3 border-2 border-black">
                         <div class="text-[10px] font-black uppercase text-gray-500">Tasks Completed</div>
                         <div id="expanded-task-count" class="text-2xl font-black text-pink-600">0</div>
                     </div>
                 </div>
            </div>
        </div>
    </div>
    
    <!-- DATA MODAL -->
    <div id="data-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#60a5fa] w-full max-w-sm transform transition-all scale-95 opacity-0 p-0" id="data-modal-content">
            <div class="bg-blue-400 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="database" class="w-6 h-6 text-black"></i>
                <h3 class="text-xl font-black text-black uppercase italic">Data Management</h3>
            </div>
            <div class="p-6">
                <p class="text-sm font-bold text-gray-600 mb-6">Manually backup your data to a JSON file or restore from one.</p>
                <div class="flex flex-col gap-3">
                    <button onclick="exportData()" class="bg-white hover:bg-green-100 text-black p-4 text-sm font-bold border-2 border-black shadow-[4px_4px_0px_0px_black] hover:shadow-[2px_2px_0px_0px_black] hover:translate-x-0.5 hover:translate-y-0.5 transition-all flex items-center justify-between group">
                        <span><i data-lucide="download" class="w-4 h-4 inline mr-2"></i> Export Backup</span>
                        <i data-lucide="arrow-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    </button>
                    
                    <button onclick="triggerImport()" class="bg-white hover:bg-orange-100 text-black p-4 text-sm font-bold border-2 border-black shadow-[4px_4px_0px_0px_black] hover:shadow-[2px_2px_0px_0px_black] hover:translate-x-0.5 hover:translate-y-0.5 transition-all flex items-center justify-between group">
                        <span><i data-lucide="upload" class="w-4 h-4 inline mr-2"></i> Import Backup</span>
                        <i data-lucide="arrow-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    </button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="importData(event)">
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeDataModal()" class="px-4 py-2 text-black hover:bg-gray-100 text-xs font-bold border-2 border-transparent hover:border-black transition-all">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME MODAL -->
    <div id="game-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[60] hidden flex flex-col items-center justify-center p-4">
        <div class="relative bg-black border-[4px] border-lime-400 shadow-[0_0_20px_rgba(190,242,100,0.5)] max-w-2xl w-full relative">
             <div class="bg-lime-400 p-2 flex justify-between items-center text-black font-black font-mono">
                 <span class="text-xl tracking-widest">FIX-IT INVADERS</span>
                 <button onclick="finishGameAndLog()" class="bg-black text-lime-400 px-3 py-1 hover:bg-gray-800 text-xs font-bold">EXIT & LOG</button>
             </div>
             <div class="relative bg-gray-900 w-full h-auto">
                <canvas id="game-canvas" width="600" height="400" class="w-full h-auto cursor-none block"></canvas>
                <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 text-center">
                    <h2 class="text-4xl font-black text-lime-400 mb-2 tracking-widest animate-pulse">READY?</h2>
                    <button onclick="startGameplay()" class="bg-lime-400 hover:bg-lime-500 text-black font-black px-6 py-3 border-2 border-black uppercase flex items-center gap-2 transition-transform hover:scale-105">START GAME</button>
                </div>
                <div id="game-over-screen" class="absolute inset-0 flex flex-col items-center justify-center hidden text-center p-8 z-30">
                    <h2 class="text-4xl font-black text-red-500 mb-2 tracking-widest animate-bounce">CRASHED!</h2>
                    <p class="text-white font-mono text-xl mb-6">SCORE: <span id="final-score" class="text-pink-400">0</span></p>
                    <div class="flex gap-4">
                        <button onclick="openShareModal()" class="bg-pink-500 hover:bg-pink-600 text-white font-black px-6 py-3 border-2 border-white uppercase flex items-center gap-2">Share</button>
                        <button onclick="restartGame()" class="bg-white hover:bg-gray-200 text-black font-black px-6 py-3 border-2 border-black uppercase flex items-center gap-2">Retry</button>
                    </div>
                </div>
             </div>
             <div class="bg-black p-4 text-center border-t-4 border-lime-400 text-lime-400 font-mono text-sm flex justify-between">
                 <span>ARROWS to Move â€¢ SPACE to Shoot</span>
                 <span>SCORE: <span id="game-score">0</span> | WAVE: <span id="game-wave">1</span></span>
             </div>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[70] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-white border-[4px] border-black shadow-[8px_8px_0px_0px_#a855f7] max-w-md w-full p-0">
             <div class="bg-purple-600 p-4 border-b-2 border-black flex items-center justify-between">
                <h3 class="text-xl font-black text-white uppercase italic">Share Station</h3>
                <button onclick="closeShareModal()" class="text-white hover:text-black"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6">
                <div id="share-card-visual" class="share-card p-6 mb-6 text-center relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-full h-1 bg-lime-400"></div>
                    <div class="flex items-center justify-center gap-2 mb-2">
                         <div class="bg-yellow-300 p-1 border-2 border-black transform -rotate-3"><i data-lucide="clapperboard" class="w-6 h-6 text-black"></i></div>
                         <h4 class="text-lime-400 font-black text-2xl tracking-widest italic">FIXIT_INVADERS</h4>
                    </div>
                    <div class="text-white font-mono text-sm mb-4">HIGH SCORE</div>
                    <div class="text-5xl font-black text-pink-500 mb-4" id="share-score-display">0000</div>
                    <div class="inline-block bg-black text-white px-2 py-0.5 text-[10px] uppercase font-bold transform skew-x-6 border border-lime-400">FixIt_InPost</div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <a id="share-linkedin" href="#" target="_blank" onclick="copyShareText();" class="bg-blue-600 text-white p-3 text-xs font-bold text-center border-2 border-black hover:bg-blue-700 flex items-center justify-center gap-2">LinkedIn</a>
                    <a id="share-whatsapp" href="#" target="_blank" onclick="copyShareText();" class="bg-green-500 text-white p-3 text-xs font-bold text-center border-2 border-black hover:bg-green-600 flex items-center justify-center gap-2">WhatsApp</a>
                </div>
                <button onclick="downloadScoreCard()" class="w-full bg-lime-400 text-black p-3 text-xs font-bold text-center border-2 border-black hover:bg-lime-500 flex items-center justify-center gap-2 mb-4">DOWNLOAD CARD</button>
                <textarea id="share-text-area" class="w-full h-24 bg-gray-100 border-2 border-black p-2 text-xs font-mono resize-none" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- API KEY MODAL -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#a855f7] w-full max-w-md transform transition-all scale-95 opacity-0 p-0" id="api-modal-content">
            <div class="bg-purple-500 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="sparkles" class="w-6 h-6 text-white"></i>
                <h3 class="text-xl font-black text-white uppercase italic">Enable Gemini AI</h3>
            </div>
            <div class="p-8">
                <p class="text-black font-medium text-sm mb-6 leading-relaxed">Enter your Google Gemini API key to enable AI features.</p>
                <input type="password" id="api-key-input" placeholder="AIzaSy..." class="w-full border-2 border-black p-3 font-mono text-sm mb-8 focus:shadow-[4px_4px_0px_0px_black] focus:outline-none transition-shadow">
                <div class="flex justify-end gap-4">
                    <button onclick="closeApiKeyModal()" class="px-6 py-3 text-black hover:bg-gray-100 text-sm font-bold border-2 border-transparent hover:border-black transition-all">Cancel</button>
                    <button onclick="saveApiKey()" class="bg-black text-white px-6 py-3 text-sm font-bold flex items-center gap-2 border-2 border-black shadow-[4px_4px_0px_0px_#bef264] hover:shadow-[2px_2px_0px_0px_#bef264] transition-all">SAVE KEY</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOM AI MODAL -->
    <div id="custom-ai-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#a855f7] w-full max-w-lg transform transition-all scale-95 opacity-0 p-0" id="custom-ai-content">
            <div class="bg-purple-500 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="wand-2" class="w-6 h-6 text-white"></i>
                <h3 class="text-xl font-black text-white uppercase italic">Custom Post-Production AI</h3>
            </div>
            <div class="p-6">
                 <!-- INSTRUCTIONS RESTORED -->
                 <p class="text-sm text-gray-600 mb-4 font-bold leading-tight">
                    Ask a custom question related to video editing, codecs, ffmpeg, or filmmaking.
                    <span class="text-purple-600 block text-xs mt-1">If you have text in the 'Raw Input' box, it will be sent as context!</span>
                </p>
                <label class="block text-[10px] font-black uppercase mb-1">Your Instruction</label>
                <textarea id="custom-ai-prompt" class="w-full h-32 border-2 border-black p-3 mb-6 text-sm font-mono focus:bg-purple-50 focus:outline-none resize-none" placeholder="e.g., 'Write an ffmpeg command...'"></textarea>
                <div class="flex justify-end gap-3">
                    <button onclick="closeCustomAiModal()" class="px-4 py-2 text-black hover:bg-gray-100 text-xs font-bold border-2 border-transparent hover:border-black transition-all">Cancel</button>
                    <button onclick="submitCustomAiTask()" class="bg-black text-white px-4 py-2 text-xs font-bold flex items-center gap-2 border-2 border-black shadow-[4px_4px_0px_0px_#a855f7] hover:shadow-[2px_2px_0px_0px_#a855f7] transition-all">RUN AI</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTE MODALS -->
    <div id="note-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#60a5fa] w-full max-w-lg transform transition-all scale-95 opacity-0 p-0" id="note-modal-content">
             <div class="bg-blue-400 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="save" class="w-6 h-6 text-white"></i>
                <h3 class="text-xl font-black text-white uppercase italic">Save Note</h3>
            </div>
            <div class="p-8">
                <label class="block text-xs font-black text-black uppercase mb-2">Title</label>
                <input type="text" id="note-title" class="w-full border-2 border-black p-2 mb-4 text-sm font-bold focus:bg-blue-50 focus:outline-none">
                <label class="block text-xs font-black text-black uppercase mb-2">Content</label>
                <textarea id="note-body" class="w-full h-40 mb-8 text-sm mono text-black border-2 border-black p-2 focus:bg-blue-50 focus:outline-none resize-none"></textarea>
                <div class="flex justify-end gap-4">
                    <button onclick="closeNoteModal()" class="px-4 py-3 text-black hover:bg-gray-100 text-sm font-bold border-2 border-transparent hover:border-black transition-all">Cancel</button>
                    <button onclick="saveNote()" class="bg-blue-500 text-white px-6 py-3 text-sm font-bold flex items-center gap-2 border-2 border-black shadow-[4px_4px_0px_0px_black] hover:shadow-[2px_2px_0px_0px_black] transition-all">SAVE IT</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="view-note-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#22d3ee] w-full max-w-lg transform transition-all scale-95 opacity-0 p-0" id="view-note-content">
            <div class="bg-cyan-400 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="file-edit" class="w-6 h-6 text-black"></i>
                <h3 class="text-xl font-black text-black uppercase italic">Edit Note</h3>
            </div>
            <div class="p-8">
                <input type="hidden" id="view-note-id">
                <label class="block text-xs font-black text-black uppercase mb-2">Title</label>
                <input type="text" id="view-note-title" class="w-full border-2 border-black p-2 mb-4 text-sm font-bold focus:bg-cyan-50 focus:outline-none">
                <label class="block text-xs font-black text-black uppercase mb-2">Content</label>
                <textarea id="view-note-body" class="w-full h-64 mb-6 text-sm mono text-black border-2 border-black p-2 focus:bg-cyan-50 focus:outline-none resize-none"></textarea>
                <div class="flex justify-between items-center">
                     <button onclick="copyNoteFromModal()" class="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 uppercase"><i data-lucide="copy" class="w-4 h-4"></i> Copy Text</button>
                    <div class="flex gap-4">
                        <button onclick="closeViewNoteModal()" class="px-6 py-3 text-black hover:bg-gray-100 text-sm font-bold border-2 border-transparent hover:border-black transition-all">Cancel</button>
                        <button onclick="saveUpdatedNote()" class="bg-black text-white px-6 py-3 text-sm font-bold flex items-center gap-2 border-2 border-black shadow-[4px_4px_0px_0px_#22d3ee] hover:shadow-[2px_2px_0px_0px_#22d3ee] transition-all">SAVE CHANGES</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOG MODALS -->
    <div id="manual-log-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#fb923c] w-full max-w-sm transform transition-all scale-95 opacity-0 p-0" id="manual-log-content">
            <div class="bg-orange-400 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="pen-tool" class="w-6 h-6 text-black"></i>
                <h3 class="text-xl font-black text-black uppercase italic">Manual Log</h3>
            </div>
            <div class="p-6">
                <label class="block text-[10px] font-black uppercase mb-1">Task Name</label>
                <input type="text" id="manual-task-name-input" class="w-full border-2 border-black p-2 mb-4 text-sm font-bold focus:bg-orange-50 focus:outline-none">
                <div class="flex gap-4 mb-6">
                    <div class="flex-1"><label class="block text-[10px] font-black uppercase mb-1">Hours</label><input type="number" id="manual-hours" min="0" value="0" class="w-full font-mono text-lg border-2 border-black p-2 focus:bg-orange-50 focus:outline-none"></div>
                    <div class="flex-1"><label class="block text-[10px] font-black uppercase mb-1">Minutes</label><input type="number" id="manual-minutes" min="0" max="59" value="0" class="w-full font-mono text-lg border-2 border-black p-2 focus:bg-orange-50 focus:outline-none"></div>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="closeManualLogModal()" class="px-4 py-2 text-black hover:bg-gray-100 text-xs font-bold border-2 border-transparent hover:border-black transition-all">Cancel</button>
                    <button onclick="saveManualLog()" class="bg-black text-white px-4 py-2 text-xs font-bold flex items-center gap-2 border-2 border-black shadow-[4px_4px_0px_0px_#fb923c] hover:shadow-[2px_2px_0px_0px_#fb923c] transition-all">ADD LOG</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#bef264] w-full max-w-sm transform transition-all scale-95 opacity-0 p-0" id="edit-task-content">
            <div class="bg-lime-400 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="edit-3" class="w-6 h-6 text-black"></i>
                <h3 class="text-xl font-black text-black uppercase italic">Edit Log</h3>
            </div>
            <div class="p-6">
                <input type="hidden" id="edit-task-id">
                <label class="block text-[10px] font-black uppercase mb-1">Task Name</label>
                <input type="text" id="edit-task-name" class="w-full border-2 border-black p-2 mb-4 text-sm font-bold focus:bg-lime-50 focus:outline-none">
                <div class="flex gap-4 mb-6">
                    <div class="flex-1"><label class="block text-[10px] font-black uppercase mb-1">Hours</label><input type="number" id="edit-task-hours" min="0" class="w-full font-mono text-lg border-2 border-black p-2 focus:bg-lime-50 focus:outline-none"></div>
                    <div class="flex-1"><label class="block text-[10px] font-black uppercase mb-1">Minutes</label><input type="number" id="edit-task-minutes" min="0" max="59" class="w-full font-mono text-lg border-2 border-black p-2 focus:bg-lime-50 focus:outline-none"></div>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="closeEditTaskModal()" class="px-4 py-2 text-black hover:bg-gray-100 text-xs font-bold border-2 border-transparent hover:border-black transition-all">Cancel</button>
                    <button onclick="saveEditedTask()" class="bg-black text-white px-4 py-2 text-xs font-bold flex items-center gap-2 border-2 border-black shadow-[4px_4px_0px_0px_#bef264] hover:shadow-[2px_2px_0px_0px_#bef264] transition-all">SAVE CHANGES</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="start-task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#14b8a6] w-full max-w-sm transform transition-all scale-95 opacity-0 p-0" id="start-task-content">
            <div class="bg-teal-400 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="play-circle" class="w-6 h-6 text-black"></i>
                <h3 class="text-xl font-black text-black uppercase italic">New Session</h3>
            </div>
            <div class="p-6">
                <label class="block text-[10px] font-black uppercase mb-1">What are you working on?</label>
                <input type="text" id="new-task-name-input" class="w-full border-2 border-black p-2 mb-6 text-sm font-bold focus:bg-teal-50 focus:outline-none" placeholder="e.g. Rough Cut Ep 1..." onkeydown="if(event.key === 'Enter') confirmStartTask()">
                <div class="flex justify-end gap-3">
                    <button onclick="closeStartTaskModal()" class="px-4 py-2 text-black hover:bg-gray-100 text-xs font-bold border-2 border-transparent hover:border-black transition-all">Cancel</button>
                    <button onclick="confirmStartTask()" class="bg-black text-white px-4 py-2 text-xs font-bold flex items-center gap-2 border-2 border-black shadow-[4px_4px_0px_0px_#14b8a6] hover:shadow-[2px_2px_0px_0px_#14b8a6] transition-all">LET'S GO</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="about-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-white border-[3px] border-black shadow-[8px_8px_0px_0px_#fde047] w-full max-w-md transform transition-all scale-95 opacity-0 p-0" id="about-modal-content">
            <div class="bg-yellow-300 p-4 border-b-2 border-black flex items-center gap-3">
                <i data-lucide="help-circle" class="w-6 h-6 text-black"></i>
                <h3 class="text-xl font-black text-black uppercase italic">What is this thing?</h3>
            </div>
            <div class="p-8 relative overflow-hidden">
                <div class="absolute top-10 right-10 w-20 h-20 bg-pink-200 rounded-full blur-xl opacity-50 pointer-events-none"></div>
                <p class="text-black font-medium text-sm mb-6 leading-relaxed relative z-10">
                    <span class="font-black">FixIt_InPost</span> is your chaotic-good utility belt for post-production.
                </p>
                <div class="space-y-3 mb-8 relative z-10">
                    <div class="flex items-center gap-3"><div class="w-8 h-8 bg-green-400 border-2 border-black flex items-center justify-center shadow-[2px_2px_0px_0px_black]"><i data-lucide="clock" class="w-4 h-4"></i></div><span class="text-sm font-bold">Auto-Fix Broken Timecodes</span></div>
                    <div class="flex items-center gap-3"><div class="w-8 h-8 bg-blue-400 border-2 border-black flex items-center justify-center shadow-[2px_2px_0px_0px_black]"><i data-lucide="network" class="w-4 h-4"></i></div><span class="text-sm font-bold">Swap Paths (Mac <-> PC)</span></div>
                    <div class="flex items-center gap-3"><div class="w-8 h-8 bg-pink-400 border-2 border-black flex items-center justify-center shadow-[2px_2px_0px_0px_black]"><i data-lucide="palette" class="w-4 h-4"></i></div><span class="text-sm font-bold">Grab Color Codes</span></div>
                    <div class="flex items-center gap-3"><div class="w-8 h-8 bg-white border-2 border-black flex items-center justify-center shadow-[2px_2px_0px_0px_black]"><i data-lucide="captions" class="w-4 h-4 text-black"></i></div><span class="text-sm font-bold">Repair Broken Captions</span></div>
                </div>
                <div class="flex justify-between items-end border-t-2 border-black pt-4 mt-2">
                     <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Developed by<br><span class="text-black text-xs">Brett Gieseke & Gemini 3 Pro</span></div>
                    <button onclick="closeAboutModal()" class="bg-black text-white px-6 py-2 text-sm font-bold border-2 border-black shadow-[4px_4px_0px_0px_#fde047] hover:shadow-[2px_2px_0px_0px_#fde047] transition-all">GOT IT</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        // Expose to window for module access
        window.notesDb = JSON.parse(localStorage.getItem('fixit_notes')) || [
            {id: 1, title: 'AAF Export Settings', body: 'Include All Audio\nSample Rate: 48kHz\nBit Depth: 24 Bit\nHandle Length: 120 frames', date: new Date().toISOString()},
            {id: 2, title: 'QC Checklist', body: '1. Check Color Gamut\n2. Audio Loudness (-24 LKFS)\n3. Title Safety\n4. Flash Frame Check', date: new Date().toISOString()}
        ];
        window.colorSwatches = JSON.parse(localStorage.getItem('fixit_colors')) || ['#a855f7', '#ec4899', '#f59e0b', '#bef264'];
        window.geminiApiKey = localStorage.getItem('fixit_gemini_key');
        window.taskHistory = JSON.parse(localStorage.getItem('fixit_task_history')) || [];
        
        let currentChecklistItems = [];
        let debounceTimer;
        let activeNoteId = null;

        // --- TIMER ENGINE REWRITE ---
        let timerInterval;
        let isTimerRunning = false;
        let timerStartTime = 0; // The timestamp when we started/resumed
        let timerAccumulatedTime = 0; // Seconds already logged before current session

        // --- DOM ELEMENTS ---
        const inputArea = document.getElementById('main-input');
        const outputArea = document.getElementById('main-output');
        const outputLabel = document.getElementById('output-label');
        const indicator = document.getElementById('process-indicator');
        const colorPreview = document.getElementById('color-preview-overlay');
        const saveColorBtn = document.getElementById('save-color-btn');
        const checklistBtn = document.getElementById('checklist-btn');
        const saveChecklistBtn = document.getElementById('save-checklist-btn');
        const checklistOverlay = document.getElementById('checklist-overlay');
        const aiBadge = document.getElementById('ai-badge');
        const apiBtnText = document.getElementById('api-btn-text');
        const apiStatusBtn = document.getElementById('api-status-btn');
        
        // Timer DOM
        const timerDisplay = document.getElementById('timer-display');
        const timerStatus = document.getElementById('timer-status');
        const timerToggleBtn = document.getElementById('timer-toggle-btn');
        const taskNameInput = document.getElementById('task-name');
        const taskHistoryList = document.getElementById('task-history-list');
        const totalTimeDisplay = document.getElementById('total-time-display');

        // --- INITIALIZATION ---
        lucide.createIcons();
        renderNotes();
        renderSwatches();
        renderTaskHistory();
        updateApiButtonState();
        setupDragAndDrop();
        
        // Initialize Timer State from Storage
        loadTimerState();

        // --- EVENT LISTENERS ---
        inputArea.addEventListener('input', () => {
            activeNoteId = null;
            handleInputSync();
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(handleInputAsync, 800);
        });
        
        inputArea.addEventListener('paste', () => {
            activeNoteId = null;
            setTimeout(() => {
                handleInputSync();
                // Ensure translation triggers on paste if key exists
                if(geminiApiKey) handleInputAsync(); 
            }, 50);
        });
        
        // --- DATA EXPORT/IMPORT LOGIC ---
        function openDataModal() {
            const modal = document.getElementById('data-modal');
            const content = document.getElementById('data-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeDataModal() {
            const modal = document.getElementById('data-modal');
            const content = document.getElementById('data-modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        async function exportData() {
            const data = {
                notes: notesDb,
                colors: colorSwatches,
                history: taskHistory,
                apiKey: geminiApiKey || '',
                exportDate: new Date().toISOString()
            };
            
            const fileName = `fixit_backup_${new Date().toISOString().slice(0,10)}.json`;
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});

            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{ description: 'FixIt Backup File', accept: { 'application/json': ['.json'] }, }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    showToast('Backup Saved Successfully!', 'success');
                    return; 
                } catch (err) { if (err.name === 'AbortError') return; console.error('File Picker Error:', err); }
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast('Backup Downloaded!', 'success');
        }

        function triggerImport() { document.getElementById('import-file-input').click(); }

        function importData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm(`Found backup from ${data.exportDate || 'Unknown Date'}.\n\nOverwrite current data?`)) {
                        if (data.notes) window.notesDb = data.notes;
                        if (data.colors) window.colorSwatches = data.colors;
                        if (data.history) window.taskHistory = data.history;
                        if (data.apiKey) window.geminiApiKey = data.apiKey;
                        saveNotesDb(false); saveColors(false); localStorage.setItem('fixit_task_history', JSON.stringify(taskHistory));
                        if(geminiApiKey) localStorage.setItem('fixit_gemini_key', geminiApiKey);
                        renderNotes(); renderSwatches(); renderTaskHistory(); updateApiButtonState();
                        showToast('Data Restored Successfully!', 'success'); closeDataModal();
                    }
                } catch (err) { console.error(err); showToast('Invalid Backup File', 'error'); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- CORE UTILITY FUNCTIONS ---
        function resetUI() {
            // Force strict reset of visibility to ensure no glitch
            outputArea.value = '';
            outputLabel.innerText = "SMART OUTPUT";
            outputLabel.className = "bg-green-300 px-2 border-2 border-black";
            indicator.className = "bg-black text-white rounded-full p-2 border-2 border-white outline outline-2 outline-black transition-all duration-500 z-10";
            
            // Force Checklist overlay hidden and Main Output visible
            document.getElementById('checklist-overlay').classList.add('hidden');
            document.getElementById('main-output').classList.remove('hidden');
            checklistBtn.classList.add('hidden');
            saveChecklistBtn.classList.add('hidden');
            
            // Reset checklist button text state
            checklistBtn.innerHTML = '<i data-lucide="check-square" class="w-3 h-3"></i> INTERACTIVE';
            lucide.createIcons();
        }

        function clearInput() {
            inputArea.value = '';
            resetUI(); // Call the strict reset
            handleInputSync(); // Double check sync logic
        }

        function updateUI(text, label, iconName) {
            outputArea.value = text;
            outputLabel.innerText = label;
            indicator.className = "bg-green-400 text-black rounded-full p-2 border-2 border-black outline outline-2 outline-black transition-all duration-500 z-10 rotate-180 scale-110";
            
            const icon = indicator.querySelector('svg'); if (icon) icon.remove();
            const i = document.createElement('i'); i.dataset.lucide = iconName; i.className = "w-6 h-6"; indicator.appendChild(i); lucide.createIcons();
            
            setTimeout(() => {
                 indicator.className = "bg-black text-white rounded-full p-2 border-2 border-white outline outline-2 outline-black transition-all duration-500 z-10";
                 indicator.innerHTML = '<i data-lucide="arrow-down" class="w-6 h-6"></i>';
                 lucide.createIcons();
            }, 1000);
        }
        
        function convertPath(text, type) {
            if (type === 'toWin') return text.replace(/\//g, '\\').replace(/^\\Volumes\\/, 'Z:\\').replace(/^\\Users\\/, 'C:\\Users\\');
            else return text.replace(/\\/g, '/').replace(/^[A-Z]:\//, '/Volumes/').replace(/^C:\/Users\//, '/Users/');
        }
        function fixTimecode(text) { return text.replace(/[.;]/g, ':'); }
        function repairSrt(text) { return text.replace(/(\d{2})[;.](\d{3})/g, '$1,$2').replace(/->/g, '-->').replace(/-->\s*-->/g, '-->'); }
        function convertRawToSrt(text) {
            let lines = text.split('\n'); let output = []; let counter = 1; let timecodeRegex = /(\d{2}[:;]\d{2}[:;]\d{2}[:;]\d{2,3})\s*-\s*(\d{2}[:;]\d{2}[:;]\d{2}[:;]\d{2,3})/;
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim(); let match = line.match(timecodeRegex);
                if (match) { if (output.length > 0 && output[output.length - 1] === '') output.pop(); if (counter > 1) output.push(''); output.push(counter++); let start = formatSrtTime(match[1]); let end = formatSrtTime(match[2]); output.push(`${start} --> ${end}`); } else if (line !== '') { output.push(line); }
            }
            return output.join('\n');
        }
        function formatSrtTime(tc) { let parts = tc.split(/[:;]/); let h = parts[0], m = parts[1], s = parts[2], f = parts[3]; if (f.length === 3) return `${h}:${m}:${s},${f}`; let ms = Math.floor((parseInt(f) / 24) * 1000); return `${h}:${m}:${s},${ms.toString().padStart(3, '0')}`; }
        function mockTranslate(text) { return "I can't translate without an API Key, but I know this isn't English! ðŸ˜Ž\n\n(Click 'Set API Key' to enable real translation)"; }

        // --- CORE & AI LOGIC ---
        function handleInputSync() {
            const text = inputArea.value;
            // Hide standard buttons first
            document.getElementById('external-link-btn').classList.add('hidden'); saveColorBtn.classList.add('hidden'); checklistBtn.classList.add('hidden'); saveChecklistBtn.classList.add('hidden'); colorPreview.classList.add('hidden'); checklistOverlay.classList.add('hidden'); aiBadge.classList.add('hidden');
            if (!text.trim()) { resetUI(); return; }
            
            const hexRegex = /^#?([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/;
            if (hexRegex.test(text.trim())) { let cleanHex = text.trim(); if (!cleanHex.startsWith('#')) cleanHex = '#' + cleanHex; updateUI(cleanHex.toUpperCase(), 'COLOR DETECTED', 'palette'); colorPreview.style.backgroundColor = cleanHex; colorPreview.classList.remove('hidden'); saveColorBtn.classList.remove('hidden'); saveColorBtn.dataset.color = cleanHex; return; }
            
            const winPathRegex = /^[a-zA-Z]:\\|^\\\\/; const macPathRegex = /^\/Volumes\/|^\/Users\/|^\//;
            if (macPathRegex.test(text)) { updateUI(convertPath(text, 'toWin'), 'PATH: MAC -> WIN', 'network'); return; }
            else if (winPathRegex.test(text)) { updateUI(convertPath(text, 'toMac'), 'PATH: WIN -> MAC', 'network'); return; }
            
            const tcRegex = /(\d{1,2})[.:;](\d{1,2})[.:;](\d{1,2})([.:;](\d{1,2}))?/;
            if (tcRegex.test(text) && !text.includes('http') && text.length < 20 && !text.includes('-')) { updateUI(fixTimecode(text), 'TIMECODE FIXED', 'clock'); return; }
            
            if (text.includes('-->') || (/\d{2}[;.]\d{2}[;.]\d{2}/.test(text) && text.includes('\n') && text.includes('-->'))) { const repaired = repairSrt(text); if (repaired !== text) { updateUI(repaired, 'CAPTIONS REPAIRED', 'captions'); return; } else { updateUI(text, 'VALID CAPTIONS DETECTED', 'captions'); return; } }
            
            const rawCapRegex = /(\d{1,2}[.:;]\d{1,2}[:;]\d{1,2}[.:;]\d{2,3})\s*[-]\s*(\d{1,2}[.:;]\d{1,2}[:;]\d{1,2}[.:;]\d{2,3})/;
            if (rawCapRegex.test(text) && !text.includes('-->')) { const converted = convertRawToSrt(text); if (converted !== text) { updateUI(converted, 'RAW CAPTIONS CONVERTED', 'captions'); return; } else { updateUI(text, 'TIMECODE RANGES DETECTED', 'clock'); return; } }
            
            // UPDATED: More aggressive foreign detection logic
            const foreignKeywords = ['hola', 'bonjour', 'hallo', 'danke', 'guten', 'ciao', 'mundo', 'monde']; const foreignRegex = /[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f\u0600-\u06FF\u00C0-\u00FF]/;
            if ((foreignKeywords.some(k => text.toLowerCase().includes(k)) || foreignRegex.test(text)) && !text.includes('[ ]') && !text.startsWith('http')) {
                 const extBtn = document.getElementById('external-link-btn'); extBtn.href = `https://translate.google.com/?sl=auto&tl=en&text=${encodeURIComponent(text)}`; extBtn.classList.remove('hidden'); 
                 if (geminiApiKey) { 
                     // IMPORTANT: Trigger async translation immediately if key exists
                     translateWithGemini(text); 
                     return; 
                 } else { 
                     updateUI(mockTranslate(text), 'FOREIGN TEXT DETECTED', 'languages'); return; 
                 }
            }
            
            if (text.includes('- [ ]') || text.includes('- [x]')) { updateUI(text, 'CHECKLIST ACTIVE', 'list-todo'); checklistBtn.classList.remove('hidden'); currentChecklistItems = text.split('\n').map(line => line.replace(/- \[[ x]\] /g, '')); toggleChecklistMode(true); return; }
            
            const feedbackKeywords = ['fix', 'change', 'cut', 'remove', 'add', 'adjust', 'feedback', 'revision', 'note', 'audio', 'video', 'clip'];
            const hasFeedbackKw = feedbackKeywords.some(k => text.toLowerCase().includes(k));
            if (hasFeedbackKw && text.length > 15 && !text.trim().startsWith('[')) { const checklist = formatFeedback(text); if (checklist.includes('[ ]')) { updateUI(checklist, 'FEEDBACK DETECTED', 'list-todo'); checklistBtn.classList.remove('hidden'); currentChecklistItems = checklist.split('\n').map(line => line.replace('- [ ] ', '')); toggleChecklistMode(true); return; } }

            if ((text.split('\n').length > 3) || text.length > 150) { outputArea.value = ">> Text block detected.\n>> Click 'Save Note' to keep this."; return; }
            outputArea.value = text; 
        }

        async function handleInputAsync() {
            const text = inputArea.value; if (!geminiApiKey || !text.trim()) return;
            if (text.includes('-->') && /\d{2}:\d{2}/.test(text)) return;
            
            // Check for translation again in async context just in case sync missed it
             const foreignRegex = /[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f\u0600-\u06FF\u00C0-\u00FF]/;
             if (foreignRegex.test(text) && !text.includes('[ ]')) {
                 translateWithGemini(text);
                 return;
             }

            const feedbackKeywords = ['fix', 'change', 'cut', 'remove', 'add', 'adjust', 'feedback', 'revision', 'note', 'audio', 'video', 'clip'];
            const hasFeedbackKw = feedbackKeywords.some(k => text.toLowerCase().includes(k));
            if (hasFeedbackKw && text.length > 15 && !text.trim().startsWith('[')) {
                outputArea.value = "âœ¨ AI is reading your feedback...\n\n(This might take a second)"; lucide.createIcons();
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Task: Summarize video feedback to concise checklist lines "- [ ] ". Feedback: "${text}"` }] }] }) });
                    const data = await response.json(); if (data.error) throw new Error(data.error.message);
                    const aiSummary = data.candidates[0].content.parts[0].text.trim();
                    outputArea.value = aiSummary; currentChecklistItems = aiSummary.split('\n').map(line => line.replace('- [ ] ', ''));
                    aiBadge.classList.remove('hidden'); checklistBtn.classList.remove('hidden'); toggleChecklistMode(true);
                } catch (error) { console.error("Gemini API Error:", error); outputArea.value = text + "\n\n(AI Offline)"; }
            }
        }

        // --- UPDATED TIMER ENGINE (Robust & Persistent) ---
        
        function loadTimerState() {
            const savedState = localStorage.getItem('fixit_timer_state');
            if (savedState) {
                const state = JSON.parse(savedState);
                timerAccumulatedTime = state.accumulated || 0;
                taskNameInput.value = state.name || '';
                
                if (state.isRunning && state.startTime) {
                    // It was running when closed. Resume it seamlessly.
                    timerStartTime = state.startTime;
                    isTimerRunning = true;
                    // Start the interval loop immediately
                    timerInterval = setInterval(updateTimerTick, 1000);
                    updateTimerTick(); // Force one update now
                    updateTimerUIState(true);
                } else {
                    // It was paused
                    isTimerRunning = false;
                    updateTimerDisplay(timerAccumulatedTime);
                    updateTimerUIState(false);
                }
            } else {
                updateTimerDisplay(0);
            }
        }

        function saveTimerState() {
            const state = {
                isRunning: isTimerRunning,
                startTime: timerStartTime, // null if paused
                accumulated: timerAccumulatedTime,
                name: taskNameInput.value
            };
            localStorage.setItem('fixit_timer_state', JSON.stringify(state));
        }

        function toggleTimer() {
            if (isTimerRunning) {
                // PAUSE
                clearInterval(timerInterval);
                isTimerRunning = false;
                
                // Calculate final time chunk
                const now = Date.now();
                const sessionDuration = (now - timerStartTime) / 1000;
                timerAccumulatedTime += sessionDuration;
                timerStartTime = 0; // Reset start time
                
                saveTimerState();
                updateTimerUIState(false);
            } else {
                // START
                const currentName = taskNameInput.value.trim();
                if (!currentName && timerAccumulatedTime === 0) {
                    openStartTaskModal();
                } else {
                    startTimerInternal();
                }
            }
        }

        function startTimerInternal() {
            timerStartTime = Date.now();
            isTimerRunning = true;
            
            updateTimerUIState(true);
            saveTimerState(); // Save immediately so refresh works
            
            // Use delta time calculation to prevent drift
            timerInterval = setInterval(updateTimerTick, 1000);
            updateTimerTick();
        }

        function updateTimerTick() {
            const now = Date.now();
            const sessionDuration = (now - timerStartTime) / 1000;
            const totalSeconds = Math.floor(timerAccumulatedTime + sessionDuration);
            updateTimerDisplay(totalSeconds);
            
            // Save state periodically to prevent data loss on crash
            if (totalSeconds % 5 === 0) saveTimerState();
        }

        function stopAndSaveTimer() {
            clearInterval(timerInterval);
            
            // Calculate final total
            let totalSeconds = timerAccumulatedTime;
            if (isTimerRunning) {
                 const now = Date.now();
                 totalSeconds += (now - timerStartTime) / 1000;
            }
            
            isTimerRunning = false;
            timerStartTime = 0;
            timerAccumulatedTime = 0;
            
            // Log it
            if (totalSeconds > 1) { // Ignore accidental clicks
                // FIX: Explicitly round to integer for final log to prevent .56ms appearing
                const finalSeconds = Math.round(totalSeconds);
                
                const taskName = taskNameInput.value.trim() || 'Untitled Task';
                const hrs = Math.floor(finalSeconds / 3600);
                const mins = Math.floor((finalSeconds % 3600) / 60);
                const secs = Math.floor(finalSeconds % 60);
                const formattedTime = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                taskHistory.unshift({ id: Date.now(), name: taskName, time: formattedTime, seconds: finalSeconds });
                localStorage.setItem('fixit_task_history', JSON.stringify(taskHistory));
                renderTaskHistory();
            }
            
            // Reset UI
            taskNameInput.value = '';
            updateTimerDisplay(0);
            updateTimerUIState(false);
            
            // Clear storage
            localStorage.removeItem('fixit_timer_state');
            
            // Close Expanded if open
            if(!document.getElementById('timer-modal').classList.contains('hidden')) {
                // We keep it open but update state
            }
        }

        function updateTimerUIState(running) {
            const btns = [document.getElementById('timer-toggle-btn'), document.getElementById('expanded-timer-toggle-btn')];
            const status = document.getElementById('timer-status');
            
            btns.forEach(btn => {
                if(!btn) return;
                if (running) {
                    btn.innerHTML = `<i data-lucide="pause" class="w-3 h-3"></i> Pause`;
                    btn.classList.replace('bg-green-400', 'bg-yellow-400');
                    btn.classList.replace('hover:bg-green-500', 'hover:bg-yellow-500');
                } else {
                    btn.innerHTML = `<i data-lucide="play" class="w-3 h-3"></i> Start`;
                    btn.classList.replace('bg-yellow-400', 'bg-green-400');
                    btn.classList.replace('hover:bg-yellow-500', 'hover:bg-green-500');
                }
            });

            if (running) {
                status.classList.replace('bg-red-500', 'bg-green-500');
                status.classList.add('animate-pulse');
            } else {
                status.classList.replace('bg-green-500', 'bg-red-500');
                status.classList.remove('animate-pulse');
            }
            lucide.createIcons();
        }

        function updateTimerDisplay(totalSeconds) {
            const hrs = Math.floor(totalSeconds / 3600);
            const mins = Math.floor((totalSeconds % 3600) / 60);
            const secs = Math.floor(totalSeconds % 60);
            const text = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            timerDisplay.innerText = text;
            
            // Update Expanded Modal too
            const expDisplay = document.getElementById('expanded-timer-display');
            if(expDisplay) expDisplay.innerText = text;
        }

        function resumeTask(id) {
            const taskIndex = taskHistory.findIndex(t => t.id === id);
            if (taskIndex === -1) return;
            if (timerAccumulatedTime > 0 || isTimerRunning) stopAndSaveTimer(); // Save current first

            const task = taskHistory[taskIndex];
            taskHistory.splice(taskIndex, 1); // Remove from history
            localStorage.setItem('fixit_task_history', JSON.stringify(taskHistory));
            
            renderTaskHistory();
            
            // Load into engine
            timerAccumulatedTime = task.seconds;
            taskNameInput.value = task.name;
            updateTimerDisplay(timerAccumulatedTime);
            
            // Auto start
            startTimerInternal();
            showToast(`Resumed: ${task.name}`);
        }

        function renderTaskHistory() {
            taskHistoryList.innerHTML = '';
            
            // Calculate Total Time
            let totalSeconds = 0;
            taskHistory.forEach(t => totalSeconds += t.seconds);
            const tHrs = Math.floor(totalSeconds / 3600);
            const tMins = Math.floor((totalSeconds % 3600) / 60);
            totalTimeDisplay.innerText = `${tHrs}h ${tMins}m`;
            
            // Update Expanded Modal Stats
            document.getElementById('expanded-total-time').innerText = `${tHrs}h ${tMins}m`;
            document.getElementById('expanded-task-count').innerText = taskHistory.length;

            if (taskHistory.length === 0) { taskHistoryList.innerHTML = '<div class="text-xs text-gray-400 text-center italic mt-4">No finished tasks yet.</div>'; return; }
            
            taskHistory.forEach((task, index) => {
                const el = document.createElement('div');
                el.className = "bg-white p-2 border-2 border-black flex justify-between items-center shadow-[2px_2px_0px_0px_rgba(0,0,0,0.1)] hover:translate-x-1 transition-transform group cursor-pointer hover:bg-yellow-50";
                el.title = "Click to Resume Task";
                el.onclick = (e) => { if (e.target.closest('button')) return; resumeTask(task.id); };
                el.innerHTML = `
                    <div class="truncate mr-2 flex-1"><div class="text-[10px] font-black uppercase text-gray-500 leading-none">Task</div><div class="text-xs font-bold text-black truncate">${task.name}</div></div>
                    <div class="flex items-center gap-2"><div class="text-xs font-mono font-bold bg-gray-100 px-1 border border-black">${task.time}</div><button onclick="openEditTaskModal(${task.id})" class="text-gray-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><i data-lucide="pencil" class="w-3 h-3"></i></button><button onclick="deleteTask(${index})" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`;
                taskHistoryList.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- EXPANDED TIMER MODAL FUNCTIONS ---
        function openExpandedTimer() {
            const modal = document.getElementById('timer-modal');
            const content = document.getElementById('timer-modal-content');
            
            // Sync Task Name display
            const nameDisplay = document.getElementById('expanded-task-name');
            nameDisplay.innerText = taskNameInput.value || "No Active Task";
            
            // Make sure UI state is synced
            updateTimerUIState(isTimerRunning);
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeExpandedTimer() {
            const modal = document.getElementById('timer-modal');
            const content = document.getElementById('timer-modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function deleteTask(index) { 
            taskHistory.splice(index, 1); 
            localStorage.setItem('fixit_task_history', JSON.stringify(taskHistory)); 
            renderTaskHistory(); 
        }

        // --- TOAST SYSTEM ---
        function showToast(message, type='success') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `px-6 py-3 bg-black text-white border-2 border-white shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] font-bold text-sm flex items-center gap-3 rounded-full transform translate-y-10 opacity-0 transition-all duration-300`;
            el.innerHTML = `<i data-lucide="${type === 'success' ? 'check' : 'info'}" class="w-4 h-4 text-${type==='success'?'green':'blue'}-400"></i> ${message}`;
            container.appendChild(el);
            lucide.createIcons();
            requestAnimationFrame(() => el.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => { el.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => el.remove(), 300); }, 3000);
        }
        
        // --- MODAL LOGIC (Manual, Edit, Start) ---
        function openManualLogModal() {
            const modal = document.getElementById('manual-log-modal'); const content = document.getElementById('manual-log-content');
            document.getElementById('manual-task-name-input').value = taskNameInput.value.trim() || 'Untitled Task';
            document.getElementById('manual-hours').value = 0; document.getElementById('manual-minutes').value = 0;
            modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
        }
        function closeManualLogModal() { const modal = document.getElementById('manual-log-modal'); const content = document.getElementById('manual-log-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }
        function saveManualLog() {
            const hrs = parseInt(document.getElementById('manual-hours').value) || 0; const mins = parseInt(document.getElementById('manual-minutes').value) || 0;
            const taskName = document.getElementById('manual-task-name-input').value.trim() || 'Untitled Task';
            if (hrs === 0 && mins === 0) { closeManualLogModal(); return; }
            const totalSeconds = (hrs * 3600) + (mins * 60); const formattedTime = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:00`;
            taskHistory.unshift({ id: Date.now(), name: taskName, time: formattedTime, seconds: totalSeconds });
            localStorage.setItem('fixit_task_history', JSON.stringify(taskHistory)); 
            
            renderTaskHistory(); closeManualLogModal();
        }

        function openEditTaskModal(id) {
            const task = taskHistory.find(t => t.id === id); if (!task) return;
            const modal = document.getElementById('edit-task-modal'); const content = document.getElementById('edit-task-content');
            document.getElementById('edit-task-id').value = id; document.getElementById('edit-task-name').value = task.name;
            const hrs = Math.floor(task.seconds / 3600); const mins = Math.floor((task.seconds % 3600) / 60);
            document.getElementById('edit-task-hours').value = hrs; document.getElementById('edit-task-minutes').value = mins;
            modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
        }
        function closeEditTaskModal() { const modal = document.getElementById('edit-task-modal'); const content = document.getElementById('edit-task-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }
        function saveEditedTask() {
            const id = parseInt(document.getElementById('edit-task-id').value); const hrs = parseInt(document.getElementById('edit-task-hours').value) || 0; const mins = parseInt(document.getElementById('edit-task-minutes').value) || 0; const name = document.getElementById('edit-task-name').value.trim() || 'Untitled Task';
            const taskIndex = taskHistory.findIndex(t => t.id === id); if (taskIndex === -1) return;
            const totalSeconds = (hrs * 3600) + (mins * 60); const formattedTime = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:00`;
            taskHistory[taskIndex] = { ...taskHistory[taskIndex], name, time: formattedTime, seconds: totalSeconds };
            localStorage.setItem('fixit_task_history', JSON.stringify(taskHistory)); 
            
            renderTaskHistory(); closeEditTaskModal();
        }

        function openStartTaskModal() { const modal = document.getElementById('start-task-modal'); const content = document.getElementById('start-task-content'); document.getElementById('new-task-name-input').value = ''; modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); document.getElementById('new-task-name-input').focus(); }, 10); }
        function closeStartTaskModal() { const modal = document.getElementById('start-task-modal'); const content = document.getElementById('start-task-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }
        function confirmStartTask() { taskNameInput.value = document.getElementById('new-task-name-input').value.trim() || "Untitled Session"; closeStartTaskModal(); toggleTimer(); }

        // --- HELPER & UTILS ---
        function openCustomAiModal() {
            if (!geminiApiKey) { showToast('Please set API Key first!', 'info'); openApiKeyModal(); return; }
            const modal = document.getElementById('custom-ai-modal'); const content = document.getElementById('custom-ai-content'); document.getElementById('custom-ai-prompt').value = '';
            modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); document.getElementById('custom-ai-prompt').focus(); }, 10);
        }
        function closeCustomAiModal() { const modal = document.getElementById('custom-ai-modal'); const content = document.getElementById('custom-ai-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }
        async function submitCustomAiTask() {
            const userPrompt = document.getElementById('custom-ai-prompt').value.trim(); const contextText = inputArea.value.trim();
            if (!userPrompt) { showToast('Please enter an instruction', 'info'); return; }
            closeCustomAiModal(); outputArea.value = "âœ¨ AI is working on your request...\n\n(Thinking about video stuff...)"; lucide.createIcons();
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Context: "${contextText}". User: "${userPrompt}". Answer as video editing expert.` }] }] }) });
                const data = await response.json(); const resultText = data.candidates[0].content.parts[0].text.trim();
                outputArea.value = resultText; document.getElementById('ai-badge').classList.remove('hidden');
            } catch (error) { outputArea.value = `Error: ${error.message}`; }
        }

        // --- SPACE INVADERS GAME LOGIC ---
        let gameAnimationFrame;
        let gameCanvas, ctx;
        let gameActive = false;
        let gameStartTime = 0;
        let isGameOver = false;
        let audioCtx = null;
        let musicInterval = null;
        const gameKeys = {};

        const GAME = {
            width: 600, height: 400,
            player: { x: 280, y: 350, width: 40, height: 24, speed: 6, color: '#bef264' },
            bullets: [], enemies: [], particles: [], enemyDir: 1, score: 0, wave: 1, frameCount: 0
        };

        function openSpaceInvaders() {
            const modal = document.getElementById('game-modal');
            const startScreen = document.getElementById('start-screen');
            const gameOverScreen = document.getElementById('game-over-screen');
            modal.classList.remove('hidden'); startScreen.classList.remove('hidden'); gameOverScreen.classList.add('hidden');
            gameCanvas = document.getElementById('game-canvas'); ctx = gameCanvas.getContext('2d');
            ctx.fillStyle = '#111'; ctx.fillRect(0, 0, GAME.width, GAME.height);
        }

        function startGameplay() {
            document.getElementById('start-screen').classList.add('hidden'); initAudio();
            gameActive = true; isGameOver = false; gameStartTime = Date.now();
            initGame(); playMusic();
        }

        function finishGameAndLog() {
            const durationSec = Math.floor((Date.now() - gameStartTime) / 1000);
            const hrs = Math.floor(durationSec / 3600); const mins = Math.floor((durationSec % 3600) / 60); const secs = durationSec % 60;
            const formattedTime = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            taskHistory.unshift({ id: Date.now(), name: "Upskilling :)", time: formattedTime, seconds: durationSec });
            localStorage.setItem('fixit_task_history', JSON.stringify(taskHistory)); 
            
            renderTaskHistory(); showToast('Time Logged: Upskilling :)', 'success'); closeSpaceInvaders();
        }

        function closeSpaceInvaders() {
            document.getElementById('game-modal').classList.add('hidden'); gameActive = false; stopMusic(); cancelAnimationFrame(gameAnimationFrame); lucide.createIcons();
        }
        
        function restartGame() { document.getElementById('game-over-screen').classList.add('hidden'); isGameOver = false; initGame(); }
        
        function initGame() {
            GAME.bullets = []; GAME.enemies = []; GAME.particles = []; GAME.score = 0; GAME.wave = 1; GAME.frameCount = 0; GAME.enemyDir = 1;
            updateHUD(); spawnWave();
            if(gameAnimationFrame) cancelAnimationFrame(gameAnimationFrame); requestAnimationFrame(gameLoop);
        }

        function spawnWave() {
            const rows = 3 + Math.min(GAME.wave, 3); const cols = 6 + Math.min(GAME.wave, 4); const speed = 1 + (GAME.wave * 0.2);
            GAME.enemyDir = 1;
            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    const colors = ['#fef08a', '#f9a8d4', '#bfdbfe', '#86efac'];
                    GAME.enemies.push({ x: 50 + c * 50, y: 40 + r * 45, width: 32, height: 32, alive: true, color: colors[Math.floor(Math.random() * colors.length)], speed: speed });
                }
            }
            showToast(`WAVE ${GAME.wave} START!`);
        }

        // Audio
        function initAudio() { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if (audioCtx.state === 'suspended') { audioCtx.resume(); } }
        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'shoot') { osc.type = 'square'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
            else if (type === 'hit') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.1); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
            else if (type === 'gameover') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(20, now + 1); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0.01, now + 1); osc.start(now); osc.stop(now + 1); }
        }
        function playMusic() {
            stopMusic(); let noteIdx = 0; const notes = [110, 110, 130, 110, 164, 146, 110, 98]; 
            musicInterval = setInterval(() => {
                if(!gameActive || isGameOver || !audioCtx) return;
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination);
                const now = audioCtx.currentTime; osc.type = 'triangle'; osc.frequency.setValueAtTime(notes[noteIdx], now); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                osc.start(now); osc.stop(now + 0.2); noteIdx = (noteIdx + 1) % notes.length;
            }, 250);
        }
        function stopMusic() { if (musicInterval) clearInterval(musicInterval); }

        window.addEventListener('keydown', e => {
            if(!gameActive) return;
            if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
            gameKeys[e.key] = true; 
            if(e.code === 'Space' && !isGameOver) { if (GAME.frameCount % 10 === 0 || gameKeys['SpaceReady']) { shootBullet(); gameKeys['SpaceReady'] = false; } }
        });
        window.addEventListener('keyup', e => { gameKeys[e.key] = false; if (e.code === 'Space') gameKeys['SpaceReady'] = true; });

        function shootBullet() { GAME.bullets.push({ x: GAME.player.x + GAME.player.width/2 - 2, y: GAME.player.y, width: 4, height: 12, speed: 8, color: '#fff' }); playSound('shoot'); }
        function gameLoop() { if (!gameActive) return; if (!isGameOver) updateGame(); drawGame(); GAME.frameCount++; gameAnimationFrame = requestAnimationFrame(gameLoop); }

        function updateGame() {
            if (gameKeys['ArrowLeft'] && GAME.player.x > 0) GAME.player.x -= GAME.player.speed;
            if (gameKeys['ArrowRight'] && GAME.player.x < GAME.width - GAME.player.width) GAME.player.x += GAME.player.speed;
            
            for (let i = GAME.bullets.length - 1; i >= 0; i--) { let b = GAME.bullets[i]; b.y -= b.speed; if (b.y < 0) GAME.bullets.splice(i, 1); }
            
            let hitWall = false; let activeEnemies = 0;
            GAME.enemies.forEach(e => {
                if (!e.alive) return;
                activeEnemies++;
                if ((e.x + e.width > GAME.width && GAME.enemyDir === 1) || (e.x < 0 && GAME.enemyDir === -1)) hitWall = true;
                if (e.y + e.height >= GAME.player.y) triggerGameOver();
            });
            if (hitWall) { GAME.enemyDir *= -1; GAME.enemies.forEach(e => e.y += 20); } else { GAME.enemies.forEach(e => e.x += (e.speed || 1) * GAME.enemyDir); }

            GAME.bullets.forEach((b, bi) => {
                GAME.enemies.forEach((e, ei) => {
                    if (e.alive && b.x < e.x + e.width && b.x + b.width > e.x && b.y < e.y + e.height && b.y + b.height > e.y) {
                        e.alive = false; GAME.bullets.splice(bi, 1); GAME.score += 50; playSound('hit');
                        for(let i=0; i<8; i++) GAME.particles.push({ x: e.x + e.width/2, y: e.y + e.height/2, vx: (Math.random() - 0.5) * 6, vy: (Math.random() - 0.5) * 6, life: 20, color: e.color, size: Math.random() * 4 + 2 });
                        updateHUD();
                    }
                });
            });
            for(let i=GAME.particles.length-1; i>=0; i--) { let p = GAME.particles[i]; p.x += p.vx; p.y += p.vy; p.life--; if(p.life <= 0) GAME.particles.splice(i, 1); }
            if (activeEnemies === 0) { GAME.wave++; spawnWave(); updateHUD(); }
        }

        function updateHUD() { document.getElementById('game-score').innerText = GAME.score; document.getElementById('game-wave').innerText = GAME.wave; }
        function triggerGameOver() { isGameOver = true; stopMusic(); playSound('gameover'); document.getElementById('final-score').innerText = GAME.score; document.getElementById('game-over-screen').classList.remove('hidden'); }
        
        function drawGame() {
            ctx.fillStyle = '#111'; ctx.fillRect(0, 0, GAME.width, GAME.height);
            ctx.strokeStyle = '#222'; ctx.beginPath(); for(let i=0; i<GAME.width; i+=40) { ctx.moveTo(i,0); ctx.lineTo(i, GAME.height); } for(let i=0; i<GAME.height; i+=40) { ctx.moveTo(0,i); ctx.lineTo(GAME.width, i); } ctx.stroke();
            ctx.fillStyle = GAME.player.color; ctx.fillRect(GAME.player.x, GAME.player.y + 10, GAME.player.width, 10); ctx.fillRect(GAME.player.x + 10, GAME.player.y, 20, 10);
            ctx.fillStyle = '#fff'; GAME.bullets.forEach(b => ctx.fillRect(b.x, b.y, b.width, b.height));
            GAME.enemies.forEach(e => { if(e.alive) { ctx.fillStyle = e.color; ctx.fillRect(e.x, e.y, e.width, e.height); ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(e.x + 4, e.y + 6, e.width - 8, 3); ctx.fillRect(e.x + 4, e.y + 14, e.width - 12, 3); } });
            GAME.particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); });
        }

        // Share & Log
        function openShareModal() {
            const modal = document.getElementById('share-modal'); document.getElementById('share-score-display').innerText = GAME.score.toString().padStart(4, '0');
            const shareText = `I just cleared ${GAME.score} points of client notes in FixIt_InPost! ðŸ‘¾ Can you beat my high score? #PostProduction #EditorLife`;
            document.getElementById('share-text-area').value = shareText;
            
            // Set WhatsApp Link
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
            document.getElementById('share-whatsapp').href = whatsappUrl;

            // Set LinkedIn Link (Text share intent)
            const linkedinUrl = `https://www.linkedin.com/feed/?shareActive=true&text=${encodeURIComponent(shareText)}`;
            document.getElementById('share-linkedin').href = linkedinUrl;
            
            modal.classList.remove('hidden');
        }
        function closeShareModal() { document.getElementById('share-modal').classList.add('hidden'); }
        function copyShareText() { document.getElementById("share-text-area").select(); document.execCommand("copy"); showToast('Text copied to clipboard!', 'success'); }
        
        function downloadScoreCard() {
            const canvas = document.createElement('canvas'); canvas.width = 400; canvas.height = 300; const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#111'; 
            ctx.fillRect(0, 0, 400, 300);
            
            // Border
            ctx.lineWidth = 8; 
            ctx.strokeStyle = '#bef264'; 
            ctx.strokeRect(0, 0, 400, 300);
            
            // --- DRAW LOGO MANUALLY (To avoid image dependencies) ---
            // Yellow Sticky Note
            ctx.save();
            ctx.translate(30, 30);
            ctx.fillStyle = '#fde047';
            ctx.fillRect(0, 0, 50, 50);
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#000';
            ctx.strokeRect(0, 0, 50, 50);
            
            // Clapperboard Icon (Simplified)
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.moveTo(10, 15); ctx.lineTo(40, 15); ctx.lineTo(40, 35); ctx.lineTo(10, 35); ctx.fill();
            // Clapper top
            ctx.beginPath();
            ctx.moveTo(10, 15); ctx.lineTo(40, 5); ctx.lineWidth=2; ctx.stroke();
            
            ctx.restore();
            
            // Text "FIXIT_INPOST"
            ctx.font = 'italic 900 28px "Arial", sans-serif';
            ctx.fillStyle = '#fff';
            ctx.fillText('FIXIT', 90, 65);
            ctx.fillStyle = '#a855f7'; // Purple
            ctx.fillText('_INPOST', 165, 65);
            
            // Text "EDITOR'S UTILITY" Badge
            ctx.fillStyle = '#000';
            ctx.fillRect(90, 75, 120, 16);
            ctx.font = 'bold 10px monospace';
            ctx.fillStyle = '#fff';
            ctx.fillText("EDITOR'S UTILITY", 95, 87);
            // ---------------------------------------------------------
            
            // High Score Label
            ctx.font = '20px monospace'; 
            ctx.fillStyle = '#fff'; 
            ctx.textAlign = 'center'; 
            ctx.fillText('HIGH SCORE', 200, 150);
            
            // Score Value
            ctx.font = 'bold 60px monospace'; 
            ctx.fillStyle = '#ec4899'; 
            ctx.fillText(GAME.score.toString().padStart(4, '0'), 200, 220);
            
            // Download
            const link = document.createElement('a'); link.download = 'fixit-highscore.png'; link.href = canvas.toDataURL(); link.click();
        }

        // --- NOTE RENDERING & LOGIC ---
        function renderNotes() {
            const container = document.getElementById('notes-list'); 
            const searchTerm = document.getElementById('note-search').value.toLowerCase(); 
            container.innerHTML = '';
            
            const filteredNotes = notesDb.filter(n => n.title.toLowerCase().includes(searchTerm) || n.body.toLowerCase().includes(searchTerm));
            
            if (filteredNotes.length === 0) { 
                container.innerHTML = '<div class="text-xs font-bold text-gray-400 text-center mt-10 uppercase">No notes found.</div>'; 
                return; 
            }

            filteredNotes.forEach(note => {
                const el = document.createElement('div'); 
                el.className = "draggable-note bg-yellow-50 p-4 border-2 border-black hover:bg-yellow-100 transition-all group relative shadow-[2px_2px_0px_0px_rgba(0,0,0,0.1)] cursor-pointer select-none";
                el.draggable = true;
                el.dataset.id = note.id;

                // Drag Events
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('dragend', handleDragEnd);

                // Click to Open Modal
                el.onclick = (e) => {
                    if (e.target.closest('button')) return; // ignore delete button click
                    const noteData = encodeURIComponent(JSON.stringify(note)).replace(/'/g, "%27");
                    loadNoteIntoModal(noteData);
                };
                
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2 pr-6 pointer-events-none">
                        <h4 class="text-sm font-black text-black leading-tight uppercase">${note.title}</h4>
                    </div>
                    <p class="text-xs text-gray-600 line-clamp-2 font-mono mb-3 border-l-2 border-black pl-2 pointer-events-none">${note.body}</p>
                    <div class="text-[10px] font-bold text-gray-400 uppercase pointer-events-none">Click to Edit</div>
                `;

                const delBtn = document.createElement('button');
                delBtn.className = "absolute top-2 right-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all p-1 z-10";
                delBtn.innerHTML = "<i data-lucide='x' class='w-4 h-4'></i>";
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteNote(note.id);
                };
                el.appendChild(delBtn);

                container.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- DRAG AND DROP HANDLERS ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (dragSrcEl !== this) {
                const srcId = parseInt(dragSrcEl.dataset.id);
                const targetId = parseInt(this.dataset.id);

                const srcIndex = notesDb.findIndex(n => n.id === srcId);
                const targetIndex = notesDb.findIndex(n => n.id === targetId);

                if (srcIndex > -1 && targetIndex > -1) {
                    // Move item in array
                    const [movedItem] = notesDb.splice(srcIndex, 1);
                    notesDb.splice(targetIndex, 0, movedItem);
                    saveNotesDb();
                    renderNotes();
                }
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            const items = document.querySelectorAll('.draggable-note');
            items.forEach(function (item) {
                item.classList.remove('drag-over');
            });
        }

        function loadNoteIntoModal(noteStr) { 
            const note = JSON.parse(decodeURIComponent(noteStr)); 
            openViewNoteModal(note.id); // This already handles populating the fields
        }

        function deleteNote(id) { 
            notesDb = notesDb.filter(n => n.id !== id); 
            saveNotesDb(); 
            renderNotes(); 
        }

        // --- COLOR PALETTE LOGIC ---
        function handleAddColor(hex) { 
            if (colorSwatches.includes(hex)) return; 
            colorSwatches.push(hex); 
            saveColors(); 
            renderSwatches(); 
        }

        function saveCurrentOutputColor() { 
            const hex = saveColorBtn.dataset.color; 
            if (hex) handleAddColor(hex); 
        }

        function removeSwatch(hex) { 
            colorSwatches = colorSwatches.filter(c => c !== hex); 
            saveColors(); 
            renderSwatches(); 
        }

        function saveColors(push = true) { 
            localStorage.setItem('fixit_colors', JSON.stringify(colorSwatches)); 
        }

        function renderSwatches() {
            const grid = document.getElementById('swatch-grid'); 
            grid.innerHTML = '';
            colorSwatches.forEach(hex => {
                const el = document.createElement('div'); 
                el.className = "relative group w-10 h-10 rounded-none cursor-pointer border-2 border-black hover:scale-110 transition-transform brutal-shadow-sm"; 
                el.style.backgroundColor = hex; 
                el.title = hex;
                el.onclick = () => { 
                    const tempInput = document.createElement('textarea'); 
                    tempInput.value = hex; 
                    tempInput.style.position = 'fixed'; 
                    tempInput.style.opacity = '0'; 
                    document.body.appendChild(tempInput); 
                    tempInput.select(); 
                    try { document.execCommand('copy'); } catch (err) {} 
                    document.body.removeChild(tempInput);
                    inputArea.value = hex; 
                    handleInputSync(); 
                    el.style.transform = "scale(0.9)"; 
                    setTimeout(() => el.style.transform = "", 200);
                    showToast('Color Copied: ' + hex, 'success');
                };
                const delBtn = document.createElement('div'); 
                delBtn.className = "absolute -top-2 -right-2 w-4 h-4 bg-red-500 border border-black flex items-center justify-center text-[10px] font-bold text-white opacity-0 group-hover:opacity-100 transition-all hover:bg-red-600 z-10"; 
                delBtn.innerHTML = "X";
                delBtn.onclick = (e) => { e.stopPropagation(); removeSwatch(hex); };
                el.appendChild(delBtn); 
                grid.appendChild(el);
            });
        }

        // --- OTHER UTILS ---
        function setupDragAndDrop() {
            // Already handled in renderNotes for individual items
        }
        function openApiKeyModal() { const modal = document.getElementById('api-key-modal'); const content = document.getElementById('api-modal-content'); document.getElementById('api-key-input').value = geminiApiKey || ''; modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeApiKeyModal() { const modal = document.getElementById('api-key-modal'); const content = document.getElementById('api-modal-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }
        function saveApiKey() { 
            const key = document.getElementById('api-key-input').value.trim(); 
            if (key) { 
                geminiApiKey = key; 
                localStorage.setItem('fixit_gemini_key', key); 
                
                updateApiButtonState(); 
                closeApiKeyModal(); 
                showToast('API Key Saved!', 'success'); 
            } 
        }
        function removeApiKey() { geminiApiKey = null; localStorage.removeItem('fixit_gemini_key'); document.getElementById('api-key-input').value = ''; updateApiButtonState(); closeApiKeyModal(); showToast('API Key Removed', 'info'); }
        function updateApiButtonState() { if (geminiApiKey) { apiBtnText.innerText = "AI ACTIVE"; apiStatusBtn.classList.add('bg-green-400', 'hover:bg-green-500', 'text-black'); apiStatusBtn.classList.remove('bg-white', 'hover:bg-gray-50'); } else { apiBtnText.innerText = "SET API KEY"; apiStatusBtn.classList.remove('bg-green-400', 'hover:bg-green-500', 'text-black'); apiStatusBtn.classList.add('bg-white', 'hover:bg-gray-50'); } lucide.createIcons(); }
        function openAboutModal() { const modal = document.getElementById('about-modal'); const content = document.getElementById('about-modal-content'); modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeAboutModal() { const modal = document.getElementById('about-modal'); const content = document.getElementById('about-modal-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }
        function openNoteModal() { const modal = document.getElementById('note-modal'); const content = document.getElementById('note-modal-content'); const titleInput = document.getElementById('note-title'); const bodyInput = document.getElementById('note-body'); if (inputArea.value.trim()) { bodyInput.value = inputArea.value; const lines = inputArea.value.split('\n'); titleInput.value = lines[0].substring(0, 30) + (lines[0].length > 30 ? '...' : ''); } else { bodyInput.value = ''; titleInput.value = ''; } modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeNoteModal() { const modal = document.getElementById('note-modal'); const content = document.getElementById('note-modal-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }
        function saveNote() { 
            const title = document.getElementById('note-title').value || 'UNTITLED'; 
            const body = document.getElementById('note-body').value; 
            if (!body) return; 
            const newId = Date.now(); 
            notesDb.unshift({ id: newId, title, body, date: new Date().toISOString() }); 
            activeNoteId = newId; 
            saveNotesDb(); 
            renderNotes(); 
            closeNoteModal(); 
            showToast('Note Saved!', 'success'); 
        }
        function openViewNoteModal(id) { const note = notesDb.find(n => n.id === id); if (!note) return; const modal = document.getElementById('view-note-modal'); const content = document.getElementById('view-note-content'); document.getElementById('view-note-id').value = id; document.getElementById('view-note-title').value = note.title; document.getElementById('view-note-body').value = note.body; modal.classList.remove('hidden'); setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeViewNoteModal() { const modal = document.getElementById('view-note-modal'); const content = document.getElementById('view-note-content'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 200); }
        function saveUpdatedNote() { 
            const id = parseInt(document.getElementById('view-note-id').value); 
            const title = document.getElementById('view-note-title').value; 
            const body = document.getElementById('view-note-body').value; 
            const index = notesDb.findIndex(n => n.id === id); 
            if (index !== -1) { 
                notesDb[index].title = title; 
                notesDb[index].body = body; 
                notesDb[index].date = new Date().toISOString(); 
                saveNotesDb(); 
                renderNotes(); 
                closeViewNoteModal(); 
                showToast('Note Updated!', 'success'); 
            } 
        }
        function copyNoteFromModal() { document.getElementById('view-note-body').select(); document.execCommand('copy'); showToast('Copied to Clipboard!', 'success'); }
        function copyOutput() { const output = document.getElementById('main-output'); output.select(); document.execCommand('copy'); const overlay = document.getElementById('copy-overlay'); overlay.style.opacity = '1'; setTimeout(() => overlay.style.opacity = '0', 1500); }
        function saveNotesDb(push=true) { 
            localStorage.setItem('fixit_notes', JSON.stringify(notesDb)); 
        }
        function formatFeedback(text) { const sentences = text.match(/[^.!?\n]+[.!?\n]*/g) || [text]; return sentences.map(s => s.trim()).filter(s => s.length > 3).map(s => summarizeSentence(s)).filter(s => s.length > 3).map(s => `- [ ] ${s}`).join('\n'); }
        function summarizeSentence(text) { let clean = text; const fillers = ["please could you", "please can you", "can you please", "could you please", "would it be possible to", "it would be great if you could", "i think we should", "i think it needs", "i feel like", "make sure to", "ensure that you", "don't forget to", "we need to", "you need to", "try to", "please", "kindly", "just", "maybe", "also", "basically"]; fillers.forEach(phrase => { clean = clean.replace(new RegExp(`^${phrase}\\s+`, 'i'), ''); }); clean = clean.replace(/^[^a-zA-Z]+/, ''); if (clean.length > 0) clean = clean.charAt(0).toUpperCase() + clean.slice(1); return clean.trim(); }
        async function translateWithGemini(text) { try { outputArea.value = "âœ¨ AI is translating...\n\n(Thinking...)"; lucide.createIcons(); const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Translate to English: "${text}"` }] }] }) }); const data = await response.json(); outputArea.value = data.candidates[0].content.parts[0].text.trim(); document.getElementById('ai-badge').classList.remove('hidden'); } catch (e) { outputArea.value = "Translation failed."; } }
        function handleManualColorSubmit() { const input = document.getElementById('manual-color-input'); const val = input.value.trim(); if(!val) return; let hex=null; if(val.startsWith('#')){hex=val;} else if(/^[0-9A-F]{3,6}$/i.test(val)){hex='#'+val;} if(hex) { handleAddColor(hex); input.value=''; showToast('Color Added', 'success'); } else { showToast('Invalid Format', 'info'); } }

    function toggleChecklistMode(forceShow = false) {
        const overlay = document.getElementById('checklist-overlay');
        const outputTextarea = document.getElementById('main-output');
        const btn = document.getElementById('checklist-btn');
        const saveBtn = document.getElementById('save-checklist-btn'); // <--- Added this selector

        const isHidden = overlay.classList.contains('hidden');

        if (forceShow || isHidden) {
            // Show Checklist & Save Button
            overlay.classList.remove('hidden');
            outputTextarea.classList.add('hidden');
            saveBtn.classList.remove('hidden'); // <--- This line reveals the button
            
            btn.innerHTML = '<i data-lucide="file-text" class="w-3 h-3"></i> RAW TEXT';
            renderChecklist();
        } else {
            // Show Raw Text & Hide Save Button
            overlay.classList.add('hidden');
            outputTextarea.classList.remove('hidden');
            saveBtn.classList.add('hidden'); // <--- This line hides it again
            
            btn.innerHTML = '<i data-lucide="check-square" class="w-3 h-3"></i> INTERACTIVE';
        }
        lucide.createIcons();
    }

    function renderChecklist() {
        const overlay = document.getElementById('checklist-overlay');
        overlay.innerHTML = ''; // Clear current

        // Header
        const header = document.createElement('div');
        header.className = "flex justify-between items-center mb-6 border-b-2 border-black pb-2";
        header.innerHTML = `
            <span class="text-xs font-black text-gray-400 uppercase tracking-widest">Interactive Task List</span>
            <span class="text-[10px] font-bold bg-purple-100 text-purple-600 px-2 py-1 rounded border border-purple-200">
                ${geminiApiKey ? 'âœ¨ AI EXPAND ACTIVE' : 'AI INACTIVE'}
            </span>
        `;
        overlay.appendChild(header);

        if (currentChecklistItems.length === 0) {
            overlay.innerHTML += '<div class="text-center text-gray-400 font-bold italic mt-10">No tasks detected. Paste feedback first!</div>';
            return;
        }

        currentChecklistItems.forEach((item, index) => {
            // Container
            const container = document.createElement('div');
            container.className = "group mb-4 transition-all";

            // Main Row
            const row = document.createElement('div');
            row.className = "flex items-start gap-3 p-2 hover:bg-gray-50 rounded transition-colors";

            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = "custom-checkbox mt-0.5 shrink-0";
            checkbox.id = `chk-${index}`;
            
            // Text Span
            const text = document.createElement('span');
            text.className = "text-sm font-bold leading-relaxed cursor-pointer border-b border-transparent hover:border-purple-400 hover:text-purple-600 transition-all select-none flex-1";
            text.innerText = item;
            text.title = "Click to ask AI for details";
            
            // Strike-through logic
            checkbox.onchange = (e) => {
                if(e.target.checked) {
                    text.classList.add('line-through', 'text-gray-400');
                    text.classList.remove('font-bold', 'text-black');
                } else {
                    text.classList.remove('line-through', 'text-gray-400');
                    text.classList.add('font-bold', 'text-black');
                }
            };

            // Click Text to Expand (The Feature Request)
            text.onclick = () => toggleTaskDetail(index, item);

            row.appendChild(checkbox);
            row.appendChild(text);

            // Expansion Box (Hidden by default)
            const detailBox = document.createElement('div');
            detailBox.id = `detail-box-${index}`;
            detailBox.className = "hidden ml-9 mt-2 p-3 bg-purple-50 border-l-4 border-purple-500 text-xs font-mono text-gray-700 shadow-sm";
            detailBox.dataset.loaded = "false"; // Track if we already asked AI

            container.appendChild(row);
            container.appendChild(detailBox);
            overlay.appendChild(container);
        });
    }

    async function toggleTaskDetail(index, taskItem) {
        const detailBox = document.getElementById(`detail-box-${index}`);
        
        // 1. Toggle Visibility
        if (!detailBox.classList.contains('hidden')) {
            detailBox.classList.add('hidden');
            return; 
        }
        detailBox.classList.remove('hidden');

        // 2. Check if already loaded
        if (detailBox.dataset.loaded === "true") return;

        // 3. Check for API Key
        if (!geminiApiKey) {
            detailBox.innerHTML = `
                <div class="font-bold text-red-500 mb-1">API Key Missing</div>
                I can't analyze this task without a Gemini API Key. Click 'Set API Key' in the top right.
            `;
            return;
        }

        // 4. Loading State
        detailBox.innerHTML = `<div class="flex items-center gap-2 text-purple-600 font-bold animate-pulse"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Reading context & generating details...</div>`;
        lucide.createIcons();

        // 5. AI Request
        const contextText = document.getElementById('main-input').value;
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `
                            You are a post-production supervisor helper.
                            
                            CONTEXT (The full client email/notes):
                            "${contextText}"
                            
                            SPECIFIC TASK TO EXPLAIN:
                            "${taskItem}"
                            
                            INSTRUCTION:
                            Look at the Context. Explain exactly what needs to be done for this specific task. 
                            If the feedback is vague (e.g., "fix ending"), use the context to find specific timestamps or details mentioned earlier.
                            Keep it brief (bullet points or 2 sentences max). 
                            If no extra context is found, suggest standard editing practices for this type of request.
                            `
                        }]
                    }]
                })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);

            const analysis = data.candidates[0].content.parts[0].text.trim();
            
            // Render Result using Markdown parser (marked.js is already included in head)
            detailBox.innerHTML = marked.parse(analysis);
            detailBox.dataset.loaded = "true";

        } catch (error) {
            console.error(error);
            detailBox.innerHTML = `<span class="text-red-500 font-bold">Error:</span> ${error.message}`;
        }
    }

function saveChecklistToNotes() {
        // 1. Safety check
        if (!currentChecklistItems || currentChecklistItems.length === 0) {
            showToast('No checklist items to save!', 'info');
            return;
        }

        // 2. Build the note body by checking the live DOM state
        const noteBody = currentChecklistItems.map((item, index) => {
            // Find the specific checkbox for this item
            const checkbox = document.getElementById(`chk-${index}`);
            // Check if it exists and is checked
            const isChecked = checkbox && checkbox.checked;
            // Format as Markdown checklist
            return `- [${isChecked ? 'x' : ' '}] ${item}`;
        }).join('\n');

        // 3. Create a Title with the current timestamp
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const noteTitle = `Checklist: ${now.toLocaleDateString()} at ${timeString}`;

        // 4. Construct the Note Object
        const newNote = {
            id: Date.now(),
            title: noteTitle,
            body: noteBody,
            date: now.toISOString()
        };

        // 5. Save to Database (LocalStorage)
        notesDb.unshift(newNote); // Add to top of list
        saveNotesDb(); // Persist to storage
        
        // 6. Refresh the Notes Panel
        renderNotes();

        // 7. Feedback
        showToast('Checklist saved to Notes!', 'success');
        
        // Optional: Open the notes panel on mobile or highlight it
        const notesPanel = document.getElementById('notes-list');
        notesPanel.scrollTop = 0;
    }
    
</script>
</body>
</html>